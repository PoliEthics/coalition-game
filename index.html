<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coalition Politics - Multiplayer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        h1 { color: #667eea; text-align: center; margin-bottom: 30px; }
        h2 { color: #333; margin: 20px 0; }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        
        .btn:hover { background: #5568d3; transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .btn-yes { background: #2ecc71; }
        .btn-yes:hover { background: #27ae60; }
        .btn-no { background: #e74c3c; }
        .btn-no:hover { background: #c0392b; }
        
        .hidden { display: none !important; }
        
        .faction-card {
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .faction-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .faction-card.selected { border-color: #667eea; background: #f0f3ff; }
        
        .faction-icon { font-size: 3em; text-align: center; margin-bottom: 10px; }
        .faction-name { font-size: 1.5em; font-weight: bold; text-align: center; }
        
        .stats-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .stat-item:last-child { border-bottom: none; }
        
        .objectives-box {
            background: #fff3cd;
            border: 3px solid #ffc107;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .objectives-box h3 { color: #856404; margin-bottom: 15px; }
        .objectives-box li { margin: 10px 0; line-height: 1.6; }
        
        .proposal-box {
            background: #e3f2fd;
            border-left: 5px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        
        .token-transfer {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .faction-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .faction-btn:hover { background: #f0f0f0; transform: scale(1.05); }
        
        select, input {
            padding: 12px;
            font-size: 1em;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 5px;
        }
        
        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            text-align: center;
        }
        
        .alert-success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }
        
        /* Message animations */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(33, 150, 243, 0.5); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
        
        @media (max-width: 768px) {
            .container { padding: 15px; }
            h1 { font-size: 1.5em; }
            .btn { padding: 12px 20px; font-size: 1em; }
        }
    </style>
</head>
<body>
    <!-- Role Selection -->
    <div id="roleSelection" class="container">
        <h1>üèõÔ∏è Coalition Politics</h1>
        <div style="text-align: center; margin-top: 50px;">
            <button class="btn" onclick="selectRole('teacher')" style="font-size: 1.5em; padding: 30px 60px;">
                üë®‚Äçüè´ I am the Teacher
            </button>
            <br><br>
            <button class="btn" onclick="selectRole('student')" style="font-size: 1.5em; padding: 30px 60px;">
                üë§ I am a Student
            </button>
            <br><br>
            <button class="btn" onclick="selectRole('display')" style="font-size: 1.5em; padding: 30px 60px; background: #9b59b6;">
                üì∫ Display Screen
            </button>
        </div>
    </div>
    
    <!-- Student Registration -->
    <div id="studentRegistration" class="container hidden">
        <h1>üë§ Student Registration</h1>
        <div style="max-width: 500px; margin: 50px auto;">
            <input type="text" id="studentName" placeholder="Your Name" style="width: 100%; padding: 15px; font-size: 1.2em; margin-bottom: 20px;">
            
            <p style="color: #666; margin: 20px 0;">You'll choose your faction after joining.</p>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="registerStudent()" style="font-size: 1.3em; padding: 20px 50px;">
                    Join Game
                </button>
            </div>
        </div>
    </div>
    
    <!-- Student Game View -->
    <div id="studentView" class="container hidden">
        <h1 id="studentTitle">üèõÔ∏è Your Faction</h1>
        
        <div id="studentFactionInfo"></div>
        <div id="studentObjectives"></div>
        <div id="studentProposal"></div>
        <div id="studentVoting"></div>
        <div id="studentResults"></div>
    </div>
    
    <!-- Teacher View -->
    <div id="teacherView" class="container hidden">
        <h1>üë®‚Äçüè´ Teacher Control Panel</h1>
        
        <div id="teacherSetup">
            <div class="alert alert-info" id="connectionInfo"></div>
            
            <div id="studentsConnected" style="margin: 20px 0;"></div>
            
            <h2>Game Status:</h2>
            <div id="teacherFactionList"></div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="startGame()" style="font-size: 1.3em; padding: 20px 50px;" id="startGameBtn" disabled>
                    Start Game
                </button>
            </div>
        </div>
        
        <div id="teacherGame" class="hidden">
            <div id="teacherRoundInfo"></div>
            <div id="teacherActivityFeed" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; max-height: 200px; overflow-y: auto;">
                <h3 style="margin-bottom: 10px;">üìä Recent Activity</h3>
                <div id="activityList" style="font-size: 0.95em;"></div>
            </div>
            <div id="teacherFactionStatus"></div>
            <div id="teacherProposalArea"></div>
            <div id="teacherVotingArea"></div>
            <div id="teacherResults"></div>
        </div>
    </div>
    
    <!-- Display Screen -->
    <div id="displayScreen" class="container hidden">
        <div style="max-width: 1400px; margin: 0 auto; padding: 30px;">
            <div id="displayHeader" style="text-align: center; margin-bottom: 40px;">
                <h1 style="font-size: 3em; margin-bottom: 10px;">üèõÔ∏è COALITION GAME</h1>
                <div id="displayPhase" style="font-size: 1.8em; color: #667eea;"></div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <!-- National Metrics -->
                <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h2 style="font-size: 2em; margin-bottom: 25px; color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 15px;">üìä NATIONAL METRICS</h2>
                    <div id="displayMetrics" style="font-size: 1.4em; line-height: 2.2;"></div>
                </div>
                
                <!-- Faction Status -->
                <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h2 style="font-size: 2em; margin-bottom: 25px; color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 15px;">üèõÔ∏è FACTION STATUS</h2>
                    <div id="displayFactions" style="font-size: 1.3em;"></div>
                </div>
            </div>
            
            <!-- Last Policy Result -->
            <div id="displayLastPolicy" style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h2 style="font-size: 2em; margin-bottom: 25px; color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 15px;">üìú POLICY HISTORY</h2>
                <div id="displayPolicyContent" style="font-size: 1.4em;">
                    <p style="color: #999; font-style: italic;">Waiting for first vote...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Initialize socket with better reconnection settings
        const socket = io({
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: Infinity,
            timeout: 20000,
            transports: ['websocket', 'polling']
        });
        
        let userRole = null;
        let myFactionId = null;
        let myIsLeader = false;
        let myStudentName = '';
        let selectedFactions = [];
        let gameData = null;
        
        // Keep-alive heartbeat - send ping every 20 seconds during inactivity
        let heartbeatInterval;
        function startHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => {
                if (socket.connected) {
                    socket.emit('heartbeat', { role: userRole, time: Date.now() });
                }
            }, 20000); // Every 20 seconds
        }
        
        // Connection event handlers
        socket.on('connect', () => {
            console.log('‚úÖ Connected to server');
            startHeartbeat();
        });
        
        socket.on('disconnect', (reason) => {
            console.log('‚ùå Disconnected from server:', reason);
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            
            // Show reconnection message to user
            if (reason === 'io server disconnect' || reason === 'transport close') {
                // Server disconnected us or network issue
                const reconnectDiv = document.createElement('div');
                reconnectDiv.id = 'reconnectMessage';
                reconnectDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #f39c12; color: white; padding: 15px 30px; border-radius: 10px; z-index: 10000; font-weight: bold;';
                reconnectDiv.innerHTML = '‚ö†Ô∏è Connection lost - Reconnecting...';
                document.body.appendChild(reconnectDiv);
            }
        });
        
        socket.on('reconnect', (attemptNumber) => {
            console.log('üîÑ Reconnected after', attemptNumber, 'attempts');
            const reconnectMsg = document.getElementById('reconnectMessage');
            if (reconnectMsg) {
                reconnectMsg.innerHTML = '‚úÖ Reconnected!';
                reconnectMsg.style.background = '#2ecc71';
                setTimeout(() => reconnectMsg.remove(), 2000);
            }
            
            // Re-register based on role
            if (userRole === 'teacher') {
                const sessionId = localStorage.getItem('teacherSessionId');
                socket.emit('registerTeacher', { sessionId });
            } else if (userRole === 'display') {
                socket.emit('registerDisplay');
            } else if (userRole === 'student' && myStudentName) {
                const sessionId = localStorage.getItem('studentSessionId');
                socket.emit('registerStudent', { name: myStudentName, sessionId });
                if (myFactionId) {
                    socket.emit('selectFaction', { factionId: myFactionId });
                }
            }
            
            startHeartbeat();
        });
        
        socket.on('reconnect_attempt', () => {
            console.log('üîÑ Attempting to reconnect...');
        });
        
        socket.on('reconnect_error', (error) => {
            console.log('‚ùå Reconnection error:', error);
        });
        
        // Start heartbeat on page load
        startHeartbeat();
        
        // Faction definitions
        const factions = [
            { id: 'socialist', name: 'Socialist Party', icon: 'üåπ', color: '#e74c3c', description: 'Equality and workers rights' },
            { id: 'liberal', name: 'Liberal Democrats', icon: 'üóΩ', color: '#3498db', description: 'Individual freedoms' },
            { id: 'conservative', name: 'Conservative Party', icon: 'ü¶Ö', color: '#34495e', description: 'Tradition and fiscal responsibility' },
            { id: 'green', name: 'Green Party', icon: 'üå±', color: '#2ecc71', description: 'Environmental sustainability' },
            { id: 'libertarian', name: 'Libertarian Party', icon: 'üêç', color: '#f39c12', description: 'Minimal government' },
            { id: 'populist', name: 'National Populist', icon: 'üé≠', color: '#9b59b6', description: 'National interests' },
            { id: 'technofeudalist', name: 'Technofeudalist Party', icon: 'ü§ñ', color: '#16a085', description: 'Tech monopolies' },
            { id: 'feminist', name: 'Feminist Party', icon: '‚ôÄÔ∏è', color: '#e91e63', description: 'Gender equality' }
        ];
        
        // Role selection
        function selectRole(role) {
            userRole = role;
            document.getElementById('roleSelection').classList.add('hidden');
            
            if (role === 'teacher') {
                const sessionId = localStorage.getItem('teacherSessionId');
                socket.emit('registerTeacher', { sessionId });
            } else if (role === 'display') {
                socket.emit('registerDisplay');
                document.getElementById('displayScreen').classList.remove('hidden');
            } else {
                showStudentRegistration();
            }
        }
        
        // Auto-select display if on /display URL
        window.addEventListener('DOMContentLoaded', () => {
            if (window.location.pathname === '/display') {
                selectRole('display');
            }
        });
        
        // Show student registration
        function showStudentRegistration() {
            document.getElementById('studentRegistration').classList.remove('hidden');
            // Faction selection now happens after joining
        }
        
        function registerStudent() {
            const name = document.getElementById('studentName').value || 'Anonymous';
            
            myStudentName = name;
            const sessionId = localStorage.getItem('studentSessionId');
            socket.emit('registerStudent', { name, sessionId });
        }
        
        // Update display screen
        function updateDisplayScreen() {
            if (!gameData) return;
            
            // Update phase header
            const phaseText = gameData.currentPhase === 'proposal' ? 'Proposal Phase' :
                            gameData.currentPhase === 'negotiation' ? 'Negotiation Phase' :
                            gameData.currentPhase === 'voting' ? 'Voting Phase' : 'Setup';
            
            document.getElementById('displayPhase').innerHTML = `
                Round ${gameData.currentRound || 1} - ${phaseText}
            `;
            
            // Update metrics
            if (gameData.metrics) {
                const metrics = gameData.metrics;
                const prevMetrics = gameData.previousMetrics || {};
                
                const getChange = (metric) => {
                    if (!prevMetrics[metric]) return '';
                    const change = metrics[metric] - prevMetrics[metric];
                    if (change === 0) return '<span style="color: #999;"> [no change]</span>';
                    const color = change > 0 ? '#2ecc71' : '#e74c3c';
                    const sign = change > 0 ? '+' : '';
                    return `<span style="color: ${color};"> [${sign}${change}]</span>`;
                };
                
                document.getElementById('displayMetrics').innerHTML = `
                    <div style="margin: 15px 0;">üí∞ <strong>GDP:</strong> ${metrics.gdp}${getChange('gdp')}</div>
                    <div style="margin: 15px 0;">üìä <strong>Inequality:</strong> ${metrics.inequality}${getChange('inequality')}</div>
                    <div style="margin: 15px 0;">üóΩ <strong>Freedom:</strong> ${metrics.freedom}${getChange('freedom')}</div>
                    <div style="margin: 15px 0;">ü§ù <strong>Social Cohesion:</strong> ${metrics.socialCohesion}${getChange('socialCohesion')}</div>
                    <div style="margin: 15px 0;">üå± <strong>Environment:</strong> ${metrics.environment}${getChange('environment')}</div>
                `;
            }
            
            // Update factions
            if (gameData.factions) {
                document.getElementById('displayFactions').innerHTML = gameData.factions
                    .sort((a, b) => (b.voterApproval || 50) - (a.voterApproval || 50))
                    .map(f => {
                        // Get students in this faction
                        let studentNames = '';
                        if (gameData.students) {
                            const studentsInFaction = Object.values(gameData.students)
                                .filter(s => s.factionId === f.id)
                                .map(s => `${s.isLeader ? 'üëë ' : ''}${s.name}`)
                                .join(', ');
                            if (studentsInFaction) {
                                studentNames = `<div style="font-size: 0.9em; color: #666; margin-top: 8px;">üë• ${studentsInFaction}</div>`;
                            }
                        }
                        
                        return `
                            <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 5px solid ${f.color};">
                                <div style="font-size: 1.2em; margin-bottom: 8px;"><strong>${f.icon} ${f.name}</strong></div>
                                ${studentNames}
                                <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                                    <span>üí∞ Capital: <strong>${f.tokens.capital}</strong></span>
                                    <span>üìä Approval: <strong>${f.voterApproval || 50}%</strong></span>
                                </div>
                            </div>
                        `;
                    }).join('');
            }
            
            // Update policy history (all votes)
            if (gameData.policyHistory && gameData.policyHistory.length > 0) {
                const historyHTML = gameData.policyHistory
                    .slice()
                    .reverse() // Show newest first
                    .map(policy => {
                        const statusColor = policy.passed ? '#2ecc71' : '#e74c3c';
                        const statusIcon = policy.passed ? '‚úÖ' : '‚ùå';
                        const statusText = policy.passed ? 'PASSED' : 'REJECTED';
                        
                        let effectsHTML = '';
                        if (policy.effects && Object.keys(policy.effects).length > 0) {
                            const effectsList = Object.entries(policy.effects).map(([metric, change]) => {
                                const label = {
                                    gdp: 'üí∞ GDP',
                                    inequality: 'üìä Inequality',
                                    freedom: 'üóΩ Freedom',
                                    socialCohesion: 'ü§ù Social Cohesion',
                                    environment: 'üå± Environment'
                                }[metric] || metric;
                                const color = change > 0 ? '#2ecc71' : '#e74c3c';
                                return `${label} <strong style="color: ${color};">${change > 0 ? '+' : ''}${change}</strong>`;
                            }).join(', ');
                            effectsHTML = `<div style="color: #666; font-size: 0.95em; margin-top: 8px;">${effectsList}</div>`;
                        }
                        
                        return `
                            <div style="padding: 15px; margin-bottom: 12px; background: #f8f9fa; border-radius: 8px; border-left: 5px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <strong style="font-size: 1.1em;">Round ${policy.round}</strong>
                                    <span style="color: ${policy.proposedByColor};">${policy.proposedByIcon} ${policy.proposedBy}</span>
                                </div>
                                <div style="font-size: 1.15em; margin-bottom: 5px;">
                                    <strong style="color: ${statusColor};">${statusIcon} "${policy.policyName}" ${statusText}</strong>
                                </div>
                                <div style="color: #666; font-size: 0.95em;">
                                    ${policy.yesVotes} YES - ${policy.noVotes} NO
                                </div>
                                ${effectsHTML}
                            </div>
                        `;
                    }).join('');
                
                document.getElementById('displayPolicyContent').innerHTML = `
                    <div style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
                        ${historyHTML}
                    </div>
                `;
            } else {
                document.getElementById('displayPolicyContent').innerHTML = `
                    <p style="color: #999; font-style: italic;">Waiting for first vote...</p>
                `;
            }
        }
        
        // Socket event handlers
        socket.on('teacherRegistered', (data) => {
            // Save session ID for reconnection
            if (data.sessionId) {
                localStorage.setItem('teacherSessionId', data.sessionId);
                console.log('üíæ Teacher session ID saved for reconnection');
            }
            
            document.getElementById('teacherView').classList.remove('hidden');
            document.getElementById('connectionInfo').innerHTML = `
                <strong>üì± Students connect to:</strong> http://${data.localIP}:3000
            `;
            initializeTeacherSetup();
            updateTeacherActivityFeed(); // Initialize empty activity feed
        });
        
        socket.on('teacherReconnected', (data) => {
            console.log('‚úÖ Teacher reconnected!');
            
            // Show success message
            const reconnectNotif = document.createElement('div');
            reconnectNotif.className = 'alert alert-success';
            reconnectNotif.innerHTML = `<strong>‚úÖ ${data.message}</strong><p>Game state restored - you can continue from where you left off!</p>`;
            reconnectNotif.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; animation: slideIn 0.3s;';
            document.body.appendChild(reconnectNotif);
            setTimeout(() => reconnectNotif.remove(), 4000);
            
            document.getElementById('teacherView').classList.remove('hidden');
            document.getElementById('connectionInfo').innerHTML = `
                <strong>üì± Students connect to:</strong> http://${data.localIP}:3000
            `;
            initializeTeacherSetup();
            updateTeacherActivityFeed();
        });
        
        socket.on('studentRegistered', (data) => {
            // Save session ID for reconnection
            if (data.sessionId) {
                localStorage.setItem('studentSessionId', data.sessionId);
                console.log('üíæ Student session ID saved for reconnection');
            }
            
            document.getElementById('studentRegistration').classList.add('hidden');
            document.getElementById('studentView').classList.remove('hidden');
            
            // Show faction selection screen
            document.getElementById('studentTitle').innerHTML = 'üèõÔ∏è Choose Your Faction';
            document.getElementById('studentFactionInfo').innerHTML = `
                <div class="alert alert-info">
                    <strong>Select a faction to join the game</strong>
                    <p>You can join any faction - work together with teammates!</p>
                </div>
                <div id="factionSelectionList" style="margin-top: 20px;"></div>
            `;
            
            // Request available factions
            updateFactionList();
        });
        
        socket.on('studentReconnected', (data) => {
            console.log('‚úÖ Student reconnected!');
            
            // Show success message
            const reconnectNotif = document.createElement('div');
            reconnectNotif.className = 'alert alert-success';
            reconnectNotif.innerHTML = `<strong>‚úÖ ${data.message}</strong><p>Returning you to your faction...</p>`;
            reconnectNotif.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; animation: slideIn 0.3s;';
            document.body.appendChild(reconnectNotif);
            setTimeout(() => reconnectNotif.remove(), 4000);
            
            // Store reconnected data
            myStudentName = data.name;
            myFactionId = data.factionId;
            
            document.getElementById('studentRegistration').classList.add('hidden');
            document.getElementById('studentView').classList.remove('hidden');
            
            // The server will send factionSelected event next
        });
        
        // Show available factions with student counts
        function updateFactionList(factionsData) {
            const allFactions = [
                { id: 'socialist', name: 'Socialist Party', icon: 'üåπ', color: '#e74c3c', description: 'Reduce inequality, increase welfare' },
                { id: 'liberal', name: 'Liberal Democrats', icon: 'üóΩ', color: '#3498db', description: 'Freedom and environment' },
                { id: 'conservative', name: 'Conservative Party', icon: 'ü¶Ö', color: '#2c3e50', description: 'Economic growth and stability' },
                { id: 'green', name: 'Green Party', icon: 'üíö', color: '#27ae60', description: 'Environmental sustainability' },
                { id: 'libertarian', name: 'Libertarian Party', icon: 'üóΩ', color: '#f39c12', description: 'Minimal government, maximum freedom' },
                { id: 'populist', name: 'Populist Movement', icon: 'üó£Ô∏è', color: '#9b59b6', description: 'National identity and cohesion' },
                { id: 'technofeudalist', name: 'Technofeudalists', icon: 'üè¢', color: '#34495e', description: 'Innovation over equality' },
                { id: 'feminist', name: 'Feminist Movement', icon: '‚ôÄÔ∏è', color: '#e91e63', description: 'Gender equality and justice' }
            ];
            
            const listDiv = document.getElementById('factionSelectionList');
            if (!listDiv) return;
            
            const studentCounts = factionsData || {};
            
            listDiv.innerHTML = allFactions.map(f => {
                const count = studentCounts[f.id] || 0;
                return `
                    <div class="stats-box" style="border-left: 5px solid ${f.color}; margin: 15px 0; cursor: pointer;" 
                         onclick="selectFaction('${f.id}')">
                        <h3>${f.icon} ${f.name} <span style="color: #666;">(${count} student${count !== 1 ? 's' : ''})</span></h3>
                        <p style="color: #666;">${f.description}</p>
                        <button class="btn" style="background: ${f.color}; margin-top: 10px;">
                            Join This Faction
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        // Student selects a faction
        function selectFaction(factionId) {
            myFactionId = factionId;
            socket.emit('selectFaction', { factionId });
            
            document.getElementById('studentFactionInfo').innerHTML = `
                <div class="alert alert-info">
                    ‚è≥ Joining faction...
                </div>
            `;
        }
        
        // Faction selected confirmation
        socket.on('factionSelected', (data) => {
            const faction = data.faction;
            myIsLeader = data.isLeader;
            
            document.getElementById('studentTitle').innerHTML = `${faction.icon} ${faction.name}`;
            document.getElementById('studentFactionInfo').innerHTML = `
                <div class="alert ${myIsLeader ? 'alert-success' : 'alert-info'}">
                    ${myIsLeader ? 'üëë <strong>You are the Faction Leader!</strong>' : 'üë• <strong>You are a Faction Advisor</strong>'}
                    <br>
                    ${myIsLeader ? 'You will vote for your faction' : 'Your leader will vote - you can discuss and advise'}
                    <br><br>
                    ‚úÖ Waiting for teacher to start the game...
                </div>
            `;
        });
        
        // Update faction list when it changes
        socket.on('factionsUpdated', (factions) => {
            const counts = {};
            factions.forEach(f => {
                counts[f.id] = f.studentCount || 0;
            });
            updateFactionList(counts);
        });
        
        socket.on('studentsUpdate', (students) => {
            // Store for later use
            if (!gameData) gameData = {};
            gameData.students = students.reduce((acc, s, i) => {
                acc[`socket${i}`] = s;
                return acc;
            }, {});
            
            const div = document.getElementById('studentsConnected');
            if (students.length === 0) {
                div.innerHTML = '<p>No students connected yet</p>';
            } else {
                // Group by faction
                const byFaction = {};
                students.forEach(s => {
                    const fid = s.factionId || 'no-faction';
                    if (!byFaction[fid]) byFaction[fid] = [];
                    byFaction[fid].push(s);
                });
                
                div.innerHTML = `<h3>üë• Connected Students (${students.length}):</h3>`;
                Object.entries(byFaction).forEach(([fid, studs]) => {
                    if (fid === 'no-faction') {
                        div.innerHTML += `<div style="margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                            <strong>‚è≥ Not yet in faction:</strong><br>
                            ${studs.map(s => `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin: 5px 0;">
                                    <span>${s.name} <small style="color: #999;">(${s.socketId?.substring(0, 8) || 'no-id'})</small></span>
                                    <button onclick="kickStudent('${s.socketId}')" style="padding: 3px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85em;">‚ùå Kick</button>
                                </div>
                            `).join('')}
                        </div>`;
                    } else {
                        const faction = factions.find(f => f.id === fid);
                        div.innerHTML += `<div style="margin: 10px 0; padding: 10px; background: ${faction?.color}22; border-left: 5px solid ${faction?.color}; border-radius: 5px;">
                            <strong>${faction?.icon} ${faction?.name}:</strong><br>
                            ${studs.map(s => `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin: 5px 0;">
                                    <span>${s.isLeader ? 'üëë' : 'üë•'} ${s.name} <small style="color: #999;">(${s.socketId?.substring(0, 8) || 'no-id'})</small></span>
                                    <button onclick="kickStudent('${s.socketId}')" style="padding: 3px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85em;">‚ùå Kick</button>
                                </div>
                            `).join('')}
                        </div>`;
                    }
                });
            }
            
            updateTeacherStartButton();
            
            // If game is active, refresh the game view to show updated student list
            if (userRole === 'teacher' && gameData && gameData.currentPhase) {
                showTeacherGame();
            }
        });
        
        // Teacher kicks a student (removes ghost connections)
        function kickStudent(socketId) {
            if (confirm('Remove this student from the game?')) {
                socket.emit('kickStudent', { socketId });
            }
        }
        
        // Teacher setup
        function initializeTeacherSetup() {
            // No faction selection needed - students choose their own
            document.getElementById('teacherFactionList').innerHTML = `
                <div class="alert alert-info">
                    <strong>Students will choose their own factions when they join.</strong>
                    <p>The game will start when you have at least 2 students in at least 2 different factions.</p>
                </div>
            `;
            updateTeacherStartButton();
        }
        
        function updateTeacherStartButton() {
            const students = Object.values(gameData?.students || {});
            const factionIds = [...new Set(students.map(s => s.factionId).filter(id => id))];
            
            const studentCount = students.filter(s => s.factionId).length;
            const factionCount = factionIds.length;
            
            const canStart = studentCount >= 2 && factionCount >= 2;
            
            document.getElementById('startGameBtn').disabled = !canStart;
            
            if (!canStart) {
                document.getElementById('startGameBtn').innerHTML = `
                    Start Game<br>
                    <small style="font-size: 0.6em;">Need: 2+ students, 2+ factions (Currently: ${studentCount} students, ${factionCount} factions)</small>
                `;
            } else {
                document.getElementById('startGameBtn').innerHTML = `
                    ‚úÖ Start Game<br>
                    <small style="font-size: 0.6em;">${studentCount} students across ${factionCount} factions</small>
                `;
            }
        }
        
        function startGame() {
            // Just send start signal - factions already selected by students
            socket.emit('startGame');
        }
        
        // Generate objectives (gameplay achievements only - no "end game" goals)
        function generateObjectives(factionId) {
            const objectives = {
                socialist: [
                    { 
                        id: 'socialist_1',
                        text: 'Pass 1 policy that reduces inequality',
                        type: 'policy_count_voted',
                        target: { metric: 'inequality', direction: 'decrease', count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'socialist_2',
                        text: 'Increase social cohesion by 10+ points',
                        type: 'metric_change',
                        target: { metric: 'socialCohesion', change: 10 },
                        completed: false,
                        progress: 0,
                        startValue: 50
                    },
                    { 
                        id: 'socialist_3',
                        text: 'Successfully block 1 policy that increases inequality',
                        type: 'block_voted',
                        target: { metric: 'inequality', direction: 'increase', count: 1 },
                        completed: false,
                        progress: 0
                    }
                ],
                liberal: [
                    { 
                        id: 'liberal_1',
                        text: 'Pass 1 environmental policy',
                        type: 'policy_count_voted',
                        target: { metric: 'environment', direction: 'increase', count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'liberal_2',
                        text: 'Increase freedom by 10+ points',
                        type: 'metric_change',
                        target: { metric: 'freedom', change: 10 },
                        completed: false,
                        progress: 0,
                        startValue: 70
                    },
                    { 
                        id: 'liberal_3',
                        text: 'Successfully block 1 policy that reduces freedom',
                        type: 'block_voted',
                        target: { metric: 'freedom', direction: 'decrease', count: 1 },
                        completed: false,
                        progress: 0
                    }
                ],
                conservative: [
                    { 
                        id: 'conservative_1',
                        text: 'Pass 1 policy that increases GDP',
                        type: 'policy_count_voted',
                        target: { metric: 'gdp', direction: 'increase', count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'conservative_2',
                        text: 'Successfully block 1 tax increase',
                        type: 'block_voted',
                        target: { policies: ['tax_rich'], count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'conservative_3',
                        text: 'Increase GDP by 10+ points',
                        type: 'metric_change',
                        target: { metric: 'gdp', change: 10 },
                        completed: false,
                        progress: 0,
                        startValue: 100
                    }
                ],
                green: [
                    { 
                        id: 'green_1',
                        text: 'Pass 1 environmental policy',
                        type: 'policy_count_voted',
                        target: { metric: 'environment', direction: 'increase', count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'green_2',
                        text: 'Increase environment by 15+ points',
                        type: 'metric_change',
                        target: { metric: 'environment', change: 15 },
                        completed: false,
                        progress: 0,
                        startValue: 50
                    },
                    { 
                        id: 'green_3',
                        text: 'Successfully block 1 policy that harms environment',
                        type: 'block_voted',
                        target: { metric: 'environment', direction: 'decrease', count: 1 },
                        completed: false,
                        progress: 0
                    }
                ],
                libertarian: [
                    { 
                        id: 'libertarian_1',
                        text: 'Pass 1 policy that increases freedom',
                        type: 'policy_count_voted',
                        target: { metric: 'freedom', direction: 'increase', count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'libertarian_2',
                        text: 'Successfully block 1 government expansion',
                        type: 'block_voted',
                        target: { policies: ['universal_healthcare', 'police_funding', 'education_funding'], count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'libertarian_3',
                        text: 'Reduce inequality by 15+ points',
                        type: 'metric_change',
                        target: { metric: 'inequality', change: -15 },
                        completed: false,
                        progress: 0,
                        startValue: 50
                    }
                ],
                populist: [
                    { 
                        id: 'populist_1',
                        text: 'Pass immigration restriction policy',
                        type: 'specific_voted',
                        target: { policy: 'immigration_restrict' },
                        completed: false
                    },
                    { 
                        id: 'populist_2',
                        text: 'Increase social cohesion by 15+ points',
                        type: 'metric_change',
                        target: { metric: 'socialCohesion', change: 15 },
                        completed: false,
                        progress: 0,
                        startValue: 50
                    },
                    { 
                        id: 'populist_3',
                        text: 'Successfully pass 2 proposals',
                        type: 'proposer_success',
                        target: { count: 2 },
                        completed: false,
                        progress: 0
                    }
                ],
                technofeudalist: [
                    { 
                        id: 'techno_1',
                        text: 'Pass 1 deregulation policy',
                        type: 'specific_voted',
                        target: { policy: 'deregulate' },
                        completed: false
                    },
                    { 
                        id: 'techno_2',
                        text: 'Increase GDP by 15+ points',
                        type: 'metric_change',
                        target: { metric: 'gdp', change: 15 },
                        completed: false,
                        progress: 0,
                        startValue: 100
                    },
                    { 
                        id: 'techno_3',
                        text: 'Successfully pass 2 proposals',
                        type: 'proposer_success',
                        target: { count: 2 },
                        completed: false,
                        progress: 0
                    }
                ],
                feminist: [
                    { 
                        id: 'feminist_1',
                        text: 'Pass 1 policy that reduces inequality',
                        type: 'policy_count_voted',
                        target: { metric: 'inequality', direction: 'decrease', count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'feminist_2',
                        text: 'Increase social cohesion by 10+ points',
                        type: 'metric_change',
                        target: { metric: 'socialCohesion', change: 10 },
                        completed: false,
                        progress: 0,
                        startValue: 50
                    },
                    { 
                        id: 'feminist_3',
                        text: 'Pass 1 policy that increases freedom',
                        type: 'policy_count_voted',
                        target: { metric: 'freedom', direction: 'increase', count: 1 },
                        completed: false,
                        progress: 0
                    }
                ]
            };
            return objectives[factionId] || [];
        }
        
        // Game start error (not enough students/factions)
        socket.on('gameStartError', (data) => {
            alert(`‚ùå Cannot start game: ${data.message}`);
        });
        
        // Game started
        socket.on('gameStarted', (game) => {
            console.log('üéÆ Game started event received');
            gameData = game; // Store complete game state
            
            if (userRole === 'teacher') {
                document.getElementById('teacherSetup').classList.add('hidden');
                document.getElementById('teacherGame').classList.remove('hidden');
                showTeacherGame();
            }
        });
        
        // Student receives faction data
        socket.on('yourFaction', (data) => {
            console.log('üì• Received faction data:', data);
            
            const faction = data.faction;
            const allFactions = data.allFactions;
            myIsLeader = data.isLeader || false; // Store leader status
            
            // Add metrics if missing
            if (!gameData) gameData = {};
            if (!gameData.metrics) {
                gameData.metrics = {
                    gdp: 100,
                    inequality: 50,
                    freedom: 70,
                    socialCohesion: 60,
                    environment: 50
                };
            }
            
            // Store factions for later use
            if (!gameData.factions) gameData.factions = [];
            gameData.factions = data.allFactions.map(af => {
                const fullFaction = gameData.factions.find(f => f.id === af.id);
                return fullFaction || af;
            });
            const myFullFaction = gameData.factions.find(f => f.id === myFactionId);
            if (myFullFaction) {
                Object.assign(myFullFaction, faction);
            } else {
                gameData.factions.push(faction);
            }
            
            // Leadership indicator
            const leadershipBadge = myIsLeader ? 
                '<div class="alert alert-success">üëë <strong>You are the Faction Leader!</strong> You will vote for your faction.</div>' :
                '<div class="alert alert-info">üë• <strong>You are a Faction Advisor.</strong> Your leader will vote - discuss and strategize together!</div>';
            
            // Show national metrics first
            const metricsHTML = `
                <div class="stats-box" style="background: #e3f2fd; border-left: 5px solid #2196f3;">
                    <h3>üìä National Metrics</h3>
                    <div class="stat-item">
                        <span>üí∞ GDP:</span>
                        <strong>${gameData.metrics.gdp}</strong>
                    </div>
                    <div class="stat-item">
                        <span>üìä Inequality:</span>
                        <strong>${gameData.metrics.inequality}</strong>
                    </div>
                    <div class="stat-item">
                        <span>üóΩ Freedom:</span>
                        <strong>${gameData.metrics.freedom}</strong>
                    </div>
                    <div class="stat-item">
                        <span>ü§ù Social Cohesion:</span>
                        <strong>${gameData.metrics.socialCohesion}</strong>
                    </div>
                    <div class="stat-item">
                        <span>üå± Environment:</span>
                        <strong>${gameData.metrics.environment}</strong>
                    </div>
                </div>
            `;
            
            // Show faction info with stats
            document.getElementById('studentFactionInfo').innerHTML = leadershipBadge + metricsHTML + `
                <div class="stats-box" style="border-left: 5px solid ${faction.color}; margin-top: 20px;">
                    <h2 style="color: ${faction.color};">${faction.icon} ${faction.name}</h2>
                    <div class="stat-item">
                        <span><strong>üí∞ Political Capital:</strong></span>
                        <span style="font-size: 1.5em; font-weight: bold; color: ${faction.color};">${faction.tokens.capital}</span>
                    </div>
                    <div class="stat-item">
                        <span><strong>üìä Voter Base Approval:</strong></span>
                        <span style="font-size: 1.5em; font-weight: bold; color: ${faction.color};">${faction.voterApproval || 0}%</span>
                    </div>
                </div>
            `;
            
            // Show objectives if they exist
            if (faction.objectives && faction.objectives.length > 0) {
                const completedCount = faction.objectives.filter(o => o.completed).length;
                const failedObjectives = faction.objectives.filter(o => o.failed);
                
                document.getElementById('studentObjectives').innerHTML = `
                    <div class="objectives-box">
                        <h3>üéØ Your Secret Objectives (${completedCount}/${faction.objectives.length} complete)</h3>
                        <div style="background: #fff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <strong style="color: #d32f2f;">‚ö†Ô∏è KEEP SECRET!</strong> Don't show other factions!
                        </div>
                        <ul style="line-height: 2;">
                            ${faction.objectives.map(obj => {
                                let status = '';
                                let style = '';
                                if (obj.completed) {
                                    status = ' ‚úÖ';
                                    style = 'style="color: #2ecc71; text-decoration: line-through;"';
                                } else if (obj.failed) {
                                    status = ' ‚ùå';
                                    style = 'style="color: #e74c3c; text-decoration: line-through;"';
                                } else if (obj.progress > 0) {
                                    // Check if it's a metric_change objective or count objective
                                    if (obj.type === 'metric_change' && obj.target.change) {
                                        const targetChange = Math.abs(obj.target.change);
                                        status = ` (${obj.progress}/${targetChange})`;
                                    } else if (obj.target.count) {
                                        status = ` (${obj.progress}/${obj.target.count})`;
                                    }
                                    style = 'style="color: #f39c12;"';
                                }
                                return `<li ${style}>${obj.text}${status}</li>`;
                            }).join('')}
                        </ul>
                        ${failedObjectives.length > 0 ? `
                            <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center; color: #721c24;">
                                <strong>‚ö†Ô∏è Warning: ${failedObjectives.length} objective(s) failed!</strong>
                            </div>
                        ` : ''}
                        ${faction.objectivesBonus ? `
                            <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin-top: 15px; text-align: center;">
                                <strong style="color: #155724; font-size: 1.3em;">üèÜ ALL OBJECTIVES COMPLETE!</strong><br>
                                <span style="color: #155724;">+10% Approval Bonus Awarded!</span>
                            </div>
                        ` : `
                            <div style="background: #fff; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
                                <strong>üèÜ Complete all 3 objectives for +10% approval bonus!</strong>
                            </div>
                        `}
                    </div>
                `;
            }
            
            // Token buttons removed from here - only shown during negotiation phase
        });
        
        // Send token
        function sendToken(toFactionId) {
            socket.emit('sendToken', { toFactionId });
            // Success notification will be shown by 'yourFaction' event or factionsUpdated
        }
        
        function launchScandal(targetFactionId) {
            if (confirm('Launch scandal campaign? This will cost 1 token and steal 2% approval from the target.')) {
                socket.emit('scandalCampaign', { 
                    attackerId: myFactionId,
                    targetId: targetFactionId 
                });
                // Success notification will be shown by 'scandalExecuted' event
            }
        }
        
        // MESSAGING FUNCTIONS
        let receivedMessages = []; // Store messages
        let teacherActivities = []; // Store teacher activity feed
        
        function addTeacherActivity(message, color = '#667eea') {
            if (userRole !== 'teacher') return;
            
            const timestamp = new Date().toLocaleTimeString();
            teacherActivities.unshift({ message, color, timestamp }); // Add to beginning
            
            // Keep only last 10 activities
            if (teacherActivities.length > 10) {
                teacherActivities = teacherActivities.slice(0, 10);
            }
            
            updateTeacherActivityFeed();
        }
        
        function updateTeacherActivityFeed() {
            const activityList = document.getElementById('activityList');
            if (!activityList) return;
            
            if (teacherActivities.length === 0) {
                activityList.innerHTML = '<p style="color: #999; font-style: italic;">No recent activity</p>';
                return;
            }
            
            activityList.innerHTML = teacherActivities.map(activity => `
                <div style="padding: 8px; margin-bottom: 8px; background: white; border-radius: 5px; border-left: 3px solid ${activity.color};">
                    <span style="color: #999; font-size: 0.85em;">${activity.timestamp}</span> - 
                    <span>${activity.message}</span>
                </div>
            `).join('');
        }
        
        function sendFactionMessage() {
            const targetFactionId = document.getElementById('messageTargetFaction').value;
            const message = document.getElementById('messageTemplate').value;
            
            if (!targetFactionId) {
                alert('‚ö†Ô∏è Please select a faction to send the message to');
                return;
            }
            
            if (!message) {
                alert('‚ö†Ô∏è Please select a message to send');
                return;
            }
            
            socket.emit('sendMessage', {
                toFactionId: targetFactionId,
                message: message
            });
            
            // Reset dropdowns
            document.getElementById('messageTargetFaction').value = '';
            document.getElementById('messageTemplate').value = '';
        }
        
        function respondToMessage(fromFactionId, response, timestamp) {
            // Mark this message as responded in the array
            const msg = receivedMessages.find(m => m.timestamp === timestamp);
            if (msg) {
                msg.responded = true;
            }
            
            socket.emit('respondToMessage', {
                toFactionId: fromFactionId,
                response: response // 'agree' or 'decline'
            });
        }
        
        function displayMessages() {
            const messageList = document.getElementById('messageList');
            if (!messageList) return;
            
            if (receivedMessages.length === 0) {
                messageList.innerHTML = '<p style="color: #666; font-style: italic;">No messages yet</p>';
                return;
            }
            
            // Show last 3 messages only
            const recentMessages = receivedMessages.slice(-3);
            
            messageList.innerHTML = recentMessages.map((msg, index) => `
                <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid ${msg.from.factionColor};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <strong style="color: ${msg.from.factionColor};">${msg.from.factionIcon} ${msg.from.factionName}:</strong>
                        <span style="font-size: 0.85em; color: #999;">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <p style="margin: 10px 0; font-size: 1.05em;">"${msg.message}"</p>
                    ${!msg.isResponse && !msg.responded ? `
                        <div style="margin-top: 12px;" id="msgButtons_${msg.timestamp}">
                            <button onclick="respondToMessage('${msg.from.factionId}', 'agree', ${msg.timestamp}); document.getElementById('msgButtons_${msg.timestamp}').innerHTML = '<span style=\\'color: #2ecc71;\\'>‚úÖ You agreed</span>';" 
                                    style="padding: 8px 16px; margin-right: 8px; background: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.95em;">
                                ‚úÖ Agree
                            </button>
                            <button onclick="respondToMessage('${msg.from.factionId}', 'decline', ${msg.timestamp}); document.getElementById('msgButtons_${msg.timestamp}').innerHTML = '<span style=\\'color: #e74c3c;\\'>‚ùå You declined</span>';" 
                                    style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.95em;">
                                ‚ùå Decline
                            </button>
                        </div>
                    ` : msg.responded ? `<div style="margin-top: 8px; color: #666; font-style: italic; font-size: 0.9em;">‚úì You responded</div>` : ''}
                    ${msg.isResponse ? '<div style="margin-top: 8px; color: #666; font-style: italic; font-size: 0.9em;">(This is a response to your message)</div>' : ''}
                </div>
            `).join('');
        }
        
        // Message received
        socket.on('messageReceived', (data) => {
            receivedMessages.push(data);
            displayMessages();
            
            // Show notification
            if (document.getElementById('messageInbox')) {
                const inbox = document.getElementById('messageInbox');
                inbox.style.animation = 'none';
                setTimeout(() => {
                    inbox.style.animation = 'pulse 0.5s';
                }, 10);
            }
        });
        
        // Message sent confirmation
        socket.on('messageSent', (data) => {
            // Show brief confirmation
            const temp = document.createElement('div');
            temp.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #2ecc71; color: white; padding: 15px 20px; border-radius: 8px; z-index: 10000; animation: slideIn 0.3s;';
            temp.innerHTML = `‚úÖ Message sent to ${data.to}!`;
            document.body.appendChild(temp);
            setTimeout(() => {
                temp.style.animation = 'slideOut 0.3s';
                setTimeout(() => temp.remove(), 300);
            }, 2000);
        });
        
        // Action rejected
        socket.on('actionRejected', (data) => {
            alert(`‚ùå ${data.reason}`);
        });
        
        socket.on('tokenSentSuccess', (data) => {
            // Show floating success notification
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success';
            successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 15px 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);';
            successDiv.innerHTML = `‚úÖ Token sent to ${data.toIcon} ${data.toFaction}!`;
            document.body.appendChild(successDiv);
            
            // Remove after 2 seconds
            setTimeout(() => {
                successDiv.remove();
            }, 2000);
        });
        
        // Scandal executed
        socket.on('scandalExecuted', (data) => {
            if (userRole === 'student') {
                const myFaction = gameData?.factions?.find(f => f.id === myFactionId);
                if (myFaction) {
                    if (data.attackerId === myFactionId) {
                        alert(`üì∞ Your scandal campaign succeeded! +2% approval (now ${data.attackerApproval}%)`);
                    } else if (data.targetId === myFactionId) {
                        alert(`‚ùå You were targeted by a scandal! -2% approval (now ${data.targetApproval}%)`);
                    } else {
                        alert(`üì∞ ${data.attacker} launched a scandal against ${data.target}!`);
                    }
                }
            }
        });
        
        socket.on('scandalFailed', (data) => {
            alert(`‚ùå Scandal failed: ${data.reason}`);
        });
        
        // Teacher activity notifications
        socket.on('teacherActivity', (data) => {
            if (userRole === 'teacher') {
                addTeacherActivity(data.message, data.color);
            }
        });
        
        // Factions updated
        socket.on('factionsUpdated', (factions) => {
            gameData.factions = factions;
            if (userRole === 'teacher') {
                showTeacherGame();
            } else if (userRole === 'student') {
                // Update token count display if it exists
                const myFaction = factions.find(f => f.id === myFactionId);
                if (myFaction && document.getElementById('myTokenCount')) {
                    document.getElementById('myTokenCount').textContent = myFaction.tokens.capital;
                }
            }
        });
        
        // Proposal selected
        socket.on('proposalSelected', (data) => {
            if (userRole === 'student') {
                document.getElementById('studentProposal').innerHTML = `
                    <div class="proposal-box">
                        <h3>üìã ${data.proposal.proposer.icon} ${data.proposal.proposer.name} proposes:</h3>
                        <h2 style="color: #2196f3; margin: 15px 0;">${data.proposal.policy.name}</h2>
                        <p style="font-size: 1.1em; line-height: 1.6;">${data.proposal.policy.description}</p>
                    </div>
                    <div class="alert alert-info">
                        ü§ù <strong>Negotiation Phase!</strong> ${myIsLeader ? 'Trade tokens with other factions before voting.' : 'Your leader can trade tokens and launch scandals. Discuss strategy with your team!'}
                    </div>
                `;
                
                // Show token transfer buttons ONLY for LEADERS during negotiation
                if (myIsLeader) {
                    const myFaction = gameData?.factions?.find(f => f.id === myFactionId);
                    if (myFaction && myFaction.tokens.capital > 0) {
                        const otherFactions = gameData.factions.filter(f => f.id !== myFactionId);
                        
                        // MESSAGING SYSTEM
                        document.getElementById('studentProposal').innerHTML += `
                            <div style="margin: 20px 0; background: #e3f2fd; padding: 20px; border-radius: 10px; border: 2px solid #2196f3;">
                                <h3>üí¨ Send Private Message:</h3>
                                <div style="margin: 15px 0;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">To Faction:</label>
                                    <select id="messageTargetFaction" style="width: 100%; padding: 10px; font-size: 1em; border-radius: 5px; border: 2px solid #2196f3;">
                                        <option value="">-- Select Faction --</option>
                                        ${otherFactions.map(f => `
                                            <option value="${f.id}">${f.icon} ${f.name}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div style="margin: 15px 0;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Message:</label>
                                    <select id="messageTemplate" style="width: 100%; padding: 10px; font-size: 1em; border-radius: 5px; border: 2px solid #2196f3;">
                                        <option value="">-- Select Message --</option>
                                        <optgroup label="ü§ù Cooperation">
                                            <option value="Let's vote YES together on this proposal">Let's vote YES together on this proposal</option>
                                            <option value="Let's vote NO together on this proposal">Let's vote NO together on this proposal</option>
                                            <option value="Want to work together for the rest of the game?">Want to work together for the rest of the game?</option>
                                            <option value="The enemy of my enemy is my friend">The enemy of my enemy is my friend</option>
                                        </optgroup>
                                        <optgroup label="üí∞ Trading">
                                            <option value="I'll give you 1 token if you vote YES">I'll give you 1 token if you vote YES</option>
                                            <option value="I'll give you 1 token if you vote NO">I'll give you 1 token if you vote NO</option>
                                            <option value="If you give me 1 token I will vote with you">If you give me 1 token I will vote with you</option>
                                        </optgroup>
                                        <optgroup label="‚ùì Questions">
                                            <option value="How are you planning to vote?">How are you planning to vote?</option>
                                            <option value="Can we negotiate?">Can we negotiate?</option>
                                        </optgroup>
                                        <optgroup label="üòä Friendly">
                                            <option value="I like you">I like you</option>
                                        </optgroup>
                                        <optgroup label="‚öîÔ∏è Hostile">
                                            <option value="I don't like you">I don't like you</option>
                                            <option value="You're the problem with this country">You're the problem with this country</option>
                                            <option value="Trust no one">Trust no one</option>
                                        </optgroup>
                                        <optgroup label="üéØ Ideological">
                                            <option value="Workers of the world, unite!">Workers of the world, unite!</option>
                                            <option value="The market will solve this">The market will solve this</option>
                                            <option value="We need more solar panels">We need more solar panels</option>
                                            <option value="The machines will solve this">The machines will solve this</option>
                                            <option value="Traditional values matter">Traditional values matter</option>
                                            <option value="Make Social Security Great Again">Make Social Security Great Again</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <button class="btn" onclick="sendFactionMessage()" style="width: 100%; background: #2196f3; font-size: 1.1em; padding: 12px;">
                                    üì® Send Message
                                </button>
                            </div>
                            
                            <div id="messageInbox" style="margin: 20px 0; background: #f5f5f5; padding: 20px; border-radius: 10px; border: 2px solid #9e9e9e;">
                                <h3>üì¨ Messages Received:</h3>
                                <div id="messageList" style="margin-top: 15px;">
                                    <p style="color: #666; font-style: italic;">No messages yet</p>
                                </div>
                            </div>
                        `;
                        
                        // TOKEN TRADING (existing code)
                        const tokenUsed = myFaction.actionsThisRound && myFaction.actionsThisRound.tokenSent;
                        const scandalUsed = myFaction.actionsThisRound && myFaction.actionsThisRound.scandalLaunched;
                        
                        document.getElementById('studentProposal').innerHTML += `
                            <div style="margin: 20px 0; background: #fff3cd; padding: 20px; border-radius: 10px;">
                                <h3>üí∞ Trade Tokens (You have <span id="myTokenCount">${myFaction.tokens.capital}</span>): ${tokenUsed ? '<span style="color: #2ecc71;">‚úì Used this round</span>' : ''}</h3>
                                <div class="token-transfer">
                                    ${tokenUsed ? '<p style="color: #856404; font-style: italic;">You can only send one token per round. Wait for next round.</p>' : otherFactions.map(f => `
                                        <button class="faction-btn" onclick="sendToken('${f.id}')" style="border-color: ${f.color};">
                                            ${f.icon} ${f.name}
                                        </button>
                                    `).join('')}
                                </div>
                                ${!tokenUsed ? '<p style="color: #856404; margin-top: 10px;">üí° Build alliances to pass/block policies!</p>' : ''}
                            </div>
                            
                            <div style="margin: 20px 0; background: #f8d7da; padding: 20px; border-radius: 10px; border: 2px solid #dc3545;">
                                <h3>üì∞ Scandal Campaign (Cost: 1 token): ${scandalUsed ? '<span style="color: #2ecc71;">‚úì Used this round</span>' : ''}</h3>
                                <p style="color: #721c24; margin-bottom: 15px;">Launch a scandal to steal 2% approval from another faction!</p>
                                <div class="token-transfer">
                                    ${scandalUsed ? '<p style="color: #721c24; font-style: italic;">You can only launch one scandal per round. Wait for next round.</p>' : otherFactions.map(f => `
                                        <button class="faction-btn" onclick="launchScandal('${f.id}')" style="border-color: ${f.color}; background: #fff; color: #dc3545;">
                                            üì∞ ${f.icon} ${f.name}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // Advisors see a message instead
                    document.getElementById('studentProposal').innerHTML += `
                        <div class="alert alert-warning" style="margin: 20px 0;">
                            üë• <strong>You are an Advisor</strong><br>
                            Only your faction leader can send messages, trade tokens, and launch scandals.<br>
                            üí¨ Discuss strategy with your team in person or via chat!
                        </div>
                        
                        <div id="messageInbox" style="margin: 20px 0; background: #f5f5f5; padding: 20px; border-radius: 10px; border: 2px solid #9e9e9e;">
                            <h3>üì¨ Messages Received:</h3>
                            <div id="messageList" style="margin-top: 15px;">
                                <p style="color: #666; font-style: italic;">No messages yet</p>
                            </div>
                            <p style="margin-top: 15px; color: #856404; font-size: 0.9em;">
                                üí° You can see messages but only your leader can respond
                            </p>
                        </div>
                    `;
                }
            }
            
            if (userRole === 'teacher') {
                gameData.currentPhase = 'negotiation';
                showTeacherGame();
            }
        });
        
        // Voting started
        socket.on('votingStarted', (proposal) => {
            if (userRole === 'student') {
                const leaderStatus = myIsLeader ? 
                    '<div class="alert alert-success">üëë You are the leader - vote for your faction!</div>' :
                    '<div class="alert alert-info">üë• You are an advisor - your leader will vote</div>';
                
                const buttonDisabled = myIsLeader ? '' : 'disabled style="opacity: 0.4; cursor: not-allowed;"';
                
                document.getElementById('studentVoting').innerHTML = `
                    ${leaderStatus}
                    <div style="text-align: center; margin: 30px 0;">
                        <h2>üó≥Ô∏è Time to Vote!</h2>
                        <p style="margin: 20px 0; font-size: 1.2em;">Should this policy pass?</p>
                        <button class="btn btn-yes" onclick="vote(true)" ${buttonDisabled} style="font-size: 1.5em; padding: 25px 50px;">
                            ‚úì YES
                        </button>
                        <button class="btn btn-no" onclick="vote(false)" ${buttonDisabled} style="font-size: 1.5em; padding: 25px 50px;">
                            ‚úó NO
                        </button>
                    </div>
                `;
            } else if (userRole === 'teacher') {
                // CRITICAL: Set phase to 'voting' before calling showTeacherGame
                if (!gameData) gameData = {};
                gameData.currentPhase = 'voting';
                // Update teacher UI with restart button
                showTeacherGame();
            }
        });
        
        // Voting restarted by teacher
        socket.on('votingRestarted', () => {
            if (userRole === 'student') {
                document.getElementById('studentVoting').innerHTML = `
                    <div class="alert alert-warning">
                        üîÑ Teacher restarted the vote. Please vote again!
                    </div>
                `;
                // Clear the voting area, votingStarted will fire next
            }
        });
        
        // Submit vote
        function vote(voteValue) {
            if (!myIsLeader) {
                alert('‚ùå Only the faction leader can vote!');
                return;
            }
            
            socket.emit('submitVote', voteValue);
            document.getElementById('studentVoting').innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ You voted <strong>${voteValue ? 'YES' : 'NO'}</strong>. Waiting for other factions...
                </div>
            `;
        }
        
        // Vote rejected (advisors trying to vote)
        socket.on('voteRejected', (data) => {
            alert(`‚ùå ${data.reason}`);
        });
        
        // Action rejected (advisors trying to trade/scandal)
        socket.on('actionRejected', (data) => {
            alert(`‚ùå ${data.reason}`);
        });
        
        // Vote results
        socket.on('voteResults', (results) => {
            // Update local game data with new metrics and factions
            if (!gameData) gameData = {};
            if (results.metrics) {
                gameData.metrics = results.metrics;
            }
            if (results.factions) {
                gameData.factions = results.factions;
            }
            
            // Check objectives after vote
            if (results.policyId && results.policyEffects) {
                checkObjectives(results.policyId, results.policyEffects, results.passed, results.metrics);
            }
            
            if (userRole === 'student') {
                const myFaction = results.factions.find(f => f.id === myFactionId);
                
                let metricsChange = '';
                if (results.passed && gameData.currentProposal && gameData.currentProposal.policy && gameData.currentProposal.policy.effects) {
                    metricsChange = '<h3>üìä National Metrics Changed:</h3><ul style="text-align: left; max-width: 400px; margin: 15px auto;">';
                    Object.entries(gameData.currentProposal.policy.effects).forEach(([metric, change]) => {
                        const label = {
                            gdp: 'üí∞ GDP',
                            inequality: 'üìä Inequality',
                            freedom: 'üóΩ Freedom',
                            socialCohesion: 'ü§ù Social Cohesion',
                            environment: 'üå± Environment'
                        }[metric] || metric;
                        metricsChange += `<li>${label}: <strong style="color: ${change > 0 ? '#2ecc71' : '#e74c3c'}">${change > 0 ? '+' : ''}${change}</strong></li>`;
                    });
                    metricsChange += '</ul>';
                }
                
                // Show objectives progress
                let objectivesStatus = '';
                if (myFaction.objectives) {
                    const completedCount = myFaction.objectives.filter(o => o.completed).length;
                    if (completedCount > 0 || myFaction.objectivesBonus) {
                        objectivesStatus = `<div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 10px;">
                            <strong>üéØ Objectives: ${completedCount}/${myFaction.objectives.length} completed</strong>
                            ${myFaction.objectivesBonus ? '<br><strong style="color: #2ecc71;">üèÜ ALL OBJECTIVES COMPLETE! +10% Approval Awarded!</strong>' : ''}
                        </div>`;
                    }
                }
                
                document.getElementById('studentResults').innerHTML = `
                    <div class="alert ${results.passed ? 'alert-success' : 'alert-warning'}">
                        <h2>üìä ${results.passed ? 'POLICY PASSED!' : 'POLICY REJECTED!'}</h2>
                        <p style="font-size: 1.2em; margin: 15px 0;">
                            ${results.yesVotes} YES votes, ${results.noVotes} NO votes
                        </p>
                        ${metricsChange}
                        ${objectivesStatus}
                        <div style="margin-top: 20px;">
                            <strong>Your new stats:</strong><br>
                            üí∞ Political Capital: ${myFaction.tokens.capital}<br>
                            üìä Voter Base Approval: ${myFaction.voterApproval || 50}%
                        </div>
                    </div>
                `;
                
                // Clear voting area and proposal area for next round
                document.getElementById('studentVoting').innerHTML = '';
                document.getElementById('studentProposal').innerHTML = `
                    <div class="alert alert-info">
                        Waiting for next proposal...
                    </div>
                `;
            }
            
            // Update teacher view
            if (userRole === 'teacher') {
                console.log('üìä Teacher: Received vote results');
                console.log('Results:', results);
                
                // Update game data FIRST
                gameData.factions = results.factions;
                if (results.metrics) gameData.metrics = results.metrics;
                
                // Update faction status display only (don't call showTeacherGame - it interferes)
                document.getElementById('teacherFactionStatus').innerHTML = `
                    <h2>Faction Status:</h2>
                    ${gameData.factions.map(f => `
                        <div class="stats-box" style="border-left: 5px solid ${f.color};">
                            <h3>${f.icon} ${f.name}</h3>
                            <div class="stat-item">
                                <span>üí∞ Political Capital:</span>
                                <strong>${f.tokens.capital}</strong>
                            </div>
                            <div class="stat-item">
                                <span>üìä Voter Base Approval:</span>
                                <strong>${f.voterApproval || 50}%</strong>
                            </div>
                        </div>
                    `).join('')}
                `;
                
                // Clear voting area
                document.getElementById('teacherVotingArea').innerHTML = '';
                
                // Show results with big, obvious continue button
                console.log('üìä Teacher: Setting results HTML');
                document.getElementById('teacherResults').innerHTML = `
                    <div class="alert ${results.passed ? 'alert-success' : 'alert-warning'}" style="margin: 20px 0; padding: 30px;">
                        <h2 style="font-size: 2em; margin-bottom: 20px;">${results.passed ? '‚úÖ POLICY PASSED!' : '‚ùå POLICY REJECTED!'}</h2>
                        <p style="font-size: 1.5em; margin: 20px 0;">
                            <strong>${results.yesVotes} YES</strong> votes, <strong>${results.noVotes} NO</strong> votes
                        </p>
                    </div>
                    <div style="text-align: center; margin: 40px 0;">
                        <button class="btn" onclick="nextRound()" style="font-size: 1.5em; padding: 25px 60px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                            ‚û°Ô∏è Continue to Next Round
                        </button>
                    </div>
                `;
                console.log('üìä Teacher: Results displayed successfully');
            }
        });
        
        // Teacher game view (simplified)
        function showTeacherGame() {
            if (!gameData) return;
            
            // Add metrics if they don't exist
            if (!gameData.metrics) {
                gameData.metrics = {
                    gdp: 100,
                    inequality: 50,
                    freedom: 70,
                    socialCohesion: 60,
                    environment: 50
                };
            }
            
            document.getElementById('teacherRoundInfo').innerHTML = `
                <div class="alert alert-info">
                    <h2>Round ${gameData.currentRound}</h2>
                    <p>Phase: ${gameData.currentPhase}</p>
                    <button class="btn" onclick="endGame()" style="background: #e74c3c; margin-top: 15px;">
                        üèÜ End Game & Show Winner
                    </button>
                </div>
                
                <div class="stats-box" style="background: #fff3cd; border-left: 5px solid #f39c12;">
                    <h3>‚ö° Random Events</h3>
                    <p style="margin-bottom: 15px; color: #856404;">Trigger major events that affect national metrics:</p>
                    <select id="randomEventSelect" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #f39c12; border-radius: 5px; font-size: 1em;">
                        <option value="">-- Select an Event --</option>
                        <optgroup label="üåç Global Events">
                            <option value="pandemic">üò∑ Global Pandemic</option>
                            <option value="economic_boom">üìà Economic Boom</option>
                            <option value="recession">üìâ Economic Recession</option>
                            <option value="climate_disaster">üå™Ô∏è Climate Disaster</option>
                        </optgroup>
                        <optgroup label="‚öîÔ∏è Conflict Events">
                            <option value="nuclear_war">‚ò¢Ô∏è Nuclear War</option>
                            <option value="civil_unrest">üî• Civil Unrest</option>
                            <option value="terrorist_attack">üí£ Terrorist Attack</option>
                        </optgroup>
                        <optgroup label="üéâ Positive Events">
                            <option value="tech_breakthrough">üöÄ Tech Breakthrough</option>
                            <option value="peace_treaty">üïäÔ∏è Peace Treaty</option>
                            <option value="resource_discovery">üíé Resource Discovery</option>
                        </optgroup>
                        <optgroup label="üèõÔ∏è Political Events">
                            <option value="corruption_scandal">üì∞ Corruption Scandal</option>
                            <option value="revolution">‚úä Revolution</option>
                            <option value="reform_success">‚öñÔ∏è Reform Success</option>
                        </optgroup>
                    </select>
                    <button class="btn" onclick="triggerRandomEvent()" style="background: #f39c12; width: 100%;">
                        ‚ö° Trigger Event
                    </button>
                </div>
                
                <div class="stats-box">
                    <h3>üìä National Metrics</h3>
                    <div class="stat-item">
                        <span>üí∞ GDP:</span>
                        <strong>${gameData.metrics.gdp}</strong>
                    </div>
                    <div class="stat-item">
                        <span>üìä Inequality:</span>
                        <strong>${gameData.metrics.inequality}</strong>
                    </div>
                    <div class="stat-item">
                        <span>üóΩ Freedom:</span>
                        <strong>${gameData.metrics.freedom}</strong>
                    </div>
                    <div class="stat-item">
                        <span>ü§ù Social Cohesion:</span>
                        <strong>${gameData.metrics.socialCohesion}</strong>
                    </div>
                    <div class="stat-item">
                        <span>üå± Environment:</span>
                        <strong>${gameData.metrics.environment}</strong>
                    </div>
                </div>
            `;
            
            // Show all factions with their stats
            document.getElementById('teacherFactionStatus').innerHTML = `
                <h2>Faction Status:</h2>
                ${gameData.factions.map(f => `
                    <div class="stats-box" style="border-left: 5px solid ${f.color};">
                        <h3>${f.icon} ${f.name}</h3>
                        <div class="stat-item">
                            <span>üí∞ Political Capital:</span>
                            <strong>${f.tokens?.capital || 0}</strong>
                        </div>
                        <div class="stat-item">
                            <span>üìä Voter Base Approval:</span>
                            <strong>${f.voterApproval || 50}%</strong>
                        </div>
                        ${f.hasVoted ? `<div style="color: #2ecc71; margin-top: 10px;">‚úì Voted ${f.vote ? 'YES' : 'NO'}</div>` : ''}
                    </div>
                `).join('')}
            `;
            
            // Show connected students during gameplay with kick buttons
            const activeStudents = Object.values(gameData.students || {});
            if (activeStudents.length > 0) {
                // Group by faction
                const byFaction = {};
                activeStudents.forEach(s => {
                    const fid = s.factionId || 'no-faction';
                    if (!byFaction[fid]) byFaction[fid] = [];
                    byFaction[fid].push(s);
                });
                
                const studentListHTML = `
                    <div class="stats-box" style="background: #f8f9fa; margin-top: 20px;">
                        <h3>üë• Connected Players (${activeStudents.length}):</h3>
                        ${Object.entries(byFaction).map(([fid, studs]) => {
                            if (fid === 'no-faction') {
                                return `<div style="margin: 10px 0; padding: 10px; background: #fff; border-radius: 5px; border: 1px solid #ddd;">
                                    <strong>‚è≥ Not in faction:</strong><br>
                                    ${studs.map(s => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 5px 0; padding: 5px;">
                                            <span>${s.name} <small style="color: #999;">(${s.socketId?.substring(0, 8)})</small></span>
                                            <button onclick="kickStudent('${s.socketId}')" style="padding: 3px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85em;">‚ùå Kick</button>
                                        </div>
                                    `).join('')}
                                </div>`;
                            } else {
                                const faction = gameData.factions.find(f => f.id === fid);
                                return `<div style="margin: 10px 0; padding: 10px; background: ${faction?.color}15; border-radius: 5px; border-left: 3px solid ${faction?.color};">
                                    <strong>${faction?.icon} ${faction?.name}:</strong><br>
                                    ${studs.map(s => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 5px 0; padding: 5px;">
                                            <span>${s.isLeader ? 'üëë' : 'üë•'} ${s.name} <small style="color: #999;">(${s.socketId?.substring(0, 8)})</small></span>
                                            <button onclick="kickStudent('${s.socketId}')" style="padding: 3px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85em;">‚ùå Kick</button>
                                        </div>
                                    `).join('')}
                                </div>`;
                            }
                        }).join('')}
                    </div>
                `;
                
                document.getElementById('teacherFactionStatus').innerHTML += studentListHTML;
            }
            
            // Teacher controls with policy selection
            if (gameData.currentPhase === 'proposal') {
                document.getElementById('teacherProposalArea').innerHTML = `
                    <h2>Select Policy to Propose:</h2>
                    <div style="margin: 20px 0;">
                        <h3>Who proposes?</h3>
                        <select id="proposerSelect" style="width: 100%; max-width: 400px;">
                            ${gameData.factions.map(f => `
                                <option value="${f.id}">${f.icon} ${f.name}</option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h3>Select Policy:</h3>
                        <select id="policySelect" style="width: 100%; max-width: 500px; font-size: 1em;">
                            <optgroup label="üí∞ Economic Policies">
                                <option value="tax_rich">Tax the Wealthy (-inequality, -gdp)</option>
                                <option value="cut_taxes">Cut Taxes (+gdp, +inequality)</option>
                                <option value="labor_rights">Strengthen Labor Rights (-inequality, -gdp)</option>
                                <option value="deregulate">Business Deregulation (+gdp, -environment)</option>
                                <option value="universal_basic_income">Universal Basic Income (-inequality, -gdp, +freedom)</option>
                                <option value="nationalize_industry">Nationalize Industries (-inequality, -freedom, -gdp)</option>
                            </optgroup>
                            <optgroup label="üå± Environmental Policies">
                                <option value="green_energy">Green Energy Investment (+environment, -gdp)</option>
                                <option value="carbon_tax">Carbon Tax (+environment, -gdp, +inequality)</option>
                            </optgroup>
                            <optgroup label="üë• Social Policies">
                                <option value="universal_healthcare">Universal Healthcare (-inequality, +cohesion)</option>
                                <option value="education_funding">Education Funding (-inequality, +cohesion)</option>
                                <option value="parental_leave">Parental Leave (-inequality, +cohesion, -gdp)</option>
                                <option value="gender_quotas">Gender Quotas (-inequality, +cohesion, -freedom)</option>
                                <option value="reproductive_rights">Reproductive Rights (+freedom, -cohesion)</option>
                            </optgroup>
                            <optgroup label="üóΩ Freedom & Security">
                                <option value="surveillance">Mass Surveillance (-freedom, -cohesion, +gdp)</option>
                                <option value="privacy_protection">Privacy Protection (+freedom, -gdp)</option>
                                <option value="police_funding">Police Funding (+cohesion, -freedom)</option>
                                <option value="drug_legalization">Drug Legalization (+freedom, -cohesion, +gdp)</option>
                                <option value="military_spending">Military Spending (+cohesion, -gdp)</option>
                            </optgroup>
                            <optgroup label="üåç Immigration">
                                <option value="immigration_open">Open Immigration (+gdp, -cohesion)</option>
                                <option value="immigration_restrict">Restrict Immigration (+cohesion, -freedom)</option>
                            </optgroup>
                            <optgroup label="ü§ñ Technology">
                                <option value="tech_monopoly">Deregulate Tech Giants (+gdp, +inequality, -freedom)</option>
                                <option value="automation">Automation Incentives (+gdp, +inequality)</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <button class="btn" onclick="teacherSelectProposal()" style="font-size: 1.2em; padding: 15px 40px;">
                        üìã Propose This Policy
                    </button>
                `;
            } else if (gameData.currentPhase === 'negotiation') {
                document.getElementById('teacherProposalArea').innerHTML = `
                    <div class="alert alert-warning" style="margin: 20px 0;">
                        <h3>ü§ù Negotiation Phase</h3>
                        <p style="font-size: 1.1em;">Students are discussing and trading tokens...</p>
                        <p style="color: #856404;">Give them time to form alliances before starting the vote.</p>
                    </div>
                    <button class="btn" onclick="startVoting()" style="font-size: 1.3em; padding: 20px 50px; margin-top: 20px;">
                        üó≥Ô∏è Start Voting
                    </button>
                `;
            } else if (gameData.currentPhase === 'voting') {
                // Only show factions that have connected students
                const connectedStudents = Object.values(gameData.students || {});
                const activeFactionIds = new Set(connectedStudents.map(s => s.factionId).filter(id => id));
                const activeFactions = gameData.factions.filter(f => activeFactionIds.has(f.id));
                
                const allVoted = activeFactions.length > 0 && activeFactions.every(f => f.hasVoted);
                
                document.getElementById('teacherVotingArea').innerHTML = `
                    <div class="alert alert-info">
                        <h3>üó≥Ô∏è Voting in Progress</h3>
                        <p>Waiting for all active factions to vote...</p>
                        ${activeFactions.map(f => `
                            <div style="margin: 5px 0;">${f.icon} ${f.name}: ${f.hasVoted ? '<strong style="color: #2ecc71;">‚úì Voted</strong>' : '<strong style="color: #f39c12;">‚è≥ Waiting...</strong>'}</div>
                        `).join('')}
                        ${activeFactions.length === 0 ? '<p style="color: #e74c3c; margin-top: 10px;">‚ö†Ô∏è No active factions with connected students!</p>' : ''}
                    </div>
                    ${allVoted ? `
                        <button class="btn" onclick="socket.emit('tallyVotes')" style="background: #27ae60; margin-top: 15px;">
                            ‚úÖ All Voted - Tally Results
                        </button>
                    ` : `
                        <button class="btn" onclick="forceEndVoting()" style="background: #e67e22; margin-top: 15px;">
                            ‚ö° Force End Voting (Count missing as NO)
                        </button>
                    `}
                    <button class="btn" onclick="restartVoting()" style="background: #95a5a6; margin-top: 15px;">
                        üîÑ Restart This Vote
                    </button>
                `;
            }
        }
        
        // Restart voting (teacher only)
        function restartVoting() {
            if (confirm('Restart the current vote? All votes will be cleared.')) {
                socket.emit('restartVoting');
            }
        }
        
        // Force end voting (teacher only) - count missing votes as NO
        function forceEndVoting() {
            if (confirm('Force end voting? All factions that haven\'t voted will be counted as voting NO.')) {
                socket.emit('forceEndVoting');
            }
        }
        
        // Get policy details
        function getPolicyDetails(policyId) {
            const policies = {
                tax_rich: { 
                    id: 'tax_rich',
                    name: 'Tax the Wealthy', 
                    description: 'Increase taxes on high earners to fund social programs',
                    effects: { inequality: -15, gdp: -5 }
                },
                cut_taxes: { 
                    id: 'cut_taxes',
                    name: 'Cut Taxes', 
                    description: 'Reduce tax burden to stimulate economic growth',
                    effects: { gdp: 10, inequality: 10 }
                },
                green_energy: { 
                    id: 'green_energy',
                    name: 'Green Energy Investment', 
                    description: 'Massive investment in renewable energy infrastructure',
                    effects: { environment: 20, gdp: -10 }
                },
                deregulate: { 
                    id: 'deregulate',
                    name: 'Business Deregulation', 
                    description: 'Remove regulations to boost business growth',
                    effects: { gdp: 15, environment: -15 }
                },
                universal_healthcare: { 
                    id: 'universal_healthcare',
                    name: 'Universal Healthcare', 
                    description: 'Implement free healthcare for all citizens',
                    effects: { inequality: -10, socialCohesion: 10 }
                },
                immigration_open: { 
                    id: 'immigration_open',
                    name: 'Open Immigration', 
                    description: 'Ease immigration restrictions to grow workforce',
                    effects: { gdp: 10, socialCohesion: -10 }
                },
                immigration_restrict: { 
                    id: 'immigration_restrict',
                    name: 'Restrict Immigration', 
                    description: 'Tighten border controls and limit immigration',
                    effects: { socialCohesion: 10, freedom: -10 }
                },
                labor_rights: { 
                    id: 'labor_rights',
                    name: 'Strengthen Labor Rights', 
                    description: 'Increase worker protections and union power',
                    effects: { inequality: -15, gdp: -8 }
                },
                education_funding: { 
                    id: 'education_funding',
                    name: 'Education Funding', 
                    description: 'Major investment in public education',
                    effects: { inequality: -8, socialCohesion: 8 }
                },
                police_funding: { 
                    id: 'police_funding',
                    name: 'Increase Police Funding', 
                    description: 'Expand law enforcement presence',
                    effects: { socialCohesion: 8, freedom: -8 }
                },
                // NEW POLICIES FOR TECHNOFEUDALISTS & FEMINISTS
                surveillance: {
                    id: 'surveillance',
                    name: 'Mass Surveillance Program',
                    description: 'Deploy AI-powered surveillance to monitor citizens',
                    effects: { freedom: -15, socialCohesion: -10, gdp: 5 }
                },
                tech_monopoly: {
                    id: 'tech_monopoly',
                    name: 'Deregulate Tech Giants',
                    description: 'Remove antitrust restrictions on technology companies',
                    effects: { gdp: 20, inequality: 15, freedom: -5 }
                },
                automation: {
                    id: 'automation',
                    name: 'Automation Incentives',
                    description: 'Tax breaks for companies that automate jobs',
                    effects: { gdp: 15, inequality: 20 }
                },
                parental_leave: {
                    id: 'parental_leave',
                    name: 'Mandatory Parental Leave',
                    description: 'Require paid parental leave for all workers',
                    effects: { inequality: -10, socialCohesion: 10, gdp: -5 }
                },
                reproductive_rights: {
                    id: 'reproductive_rights',
                    name: 'Expand Reproductive Rights',
                    description: 'Guarantee access to reproductive healthcare',
                    effects: { freedom: 15, socialCohesion: -5 }
                },
                gender_quotas: {
                    id: 'gender_quotas',
                    name: 'Corporate Gender Quotas',
                    description: 'Mandate gender balance in corporate leadership',
                    effects: { inequality: -12, freedom: -3, socialCohesion: 5 }
                },
                privacy_protection: {
                    id: 'privacy_protection',
                    name: 'Data Privacy Protection',
                    description: 'Strict regulations on data collection and use',
                    effects: { freedom: 15, gdp: -10 }
                },
                carbon_tax: {
                    id: 'carbon_tax',
                    name: 'Carbon Tax',
                    description: 'Tax carbon emissions to fight climate change',
                    effects: { environment: 15, gdp: -10, inequality: 5 }
                },
                universal_basic_income: {
                    id: 'universal_basic_income',
                    name: 'Universal Basic Income',
                    description: 'Provide guaranteed income to all citizens',
                    effects: { inequality: -20, gdp: -15, freedom: 10 }
                },
                drug_legalization: {
                    id: 'drug_legalization',
                    name: 'Drug Legalization',
                    description: 'Legalize and regulate recreational drugs',
                    effects: { freedom: 20, socialCohesion: -8, gdp: 5 }
                },
                nationalize_industry: {
                    id: 'nationalize_industry',
                    name: 'Nationalize Key Industries',
                    description: 'Put critical infrastructure under state control',
                    effects: { inequality: -15, freedom: -10, gdp: -5 }
                },
                military_spending: {
                    id: 'military_spending',
                    name: 'Increase Military Spending',
                    description: 'Expand defense budget and capabilities',
                    effects: { gdp: -10, socialCohesion: 5 }
                }
            };
            return policies[policyId];
        }
        
        // Check objectives after vote
        function checkObjectives(policyId, policyEffects, passed, metrics) {
            if (!gameData || !gameData.factions) return;
            
            gameData.factions.forEach(faction => {
                if (!faction.objectives) return;
                
                let objectivesCompleted = 0;
                let allComplete = true;
                
                faction.objectives.forEach(obj => {
                    if (obj.completed) {
                        objectivesCompleted++;
                        return;
                    }
                    
                    // Policy count objectives (pass policies that affect certain metrics)
                    if (obj.type === 'policy_count' && passed && policyEffects) {
                        console.log(`üîç Checking policy_count objective for ${faction.name}: ${obj.text}`);
                        console.log(`   Policy effects:`, policyEffects);
                        console.log(`   Target metric: ${obj.target.metric}, direction: ${obj.target.direction}`);
                        
                        if (obj.target.metric) {
                            const effect = policyEffects[obj.target.metric];
                            console.log(`   Effect on ${obj.target.metric}: ${effect}`);
                            
                            if (effect) {
                                const matchesDirection = obj.target.direction === 'increase' ? effect > 0 : effect < 0;
                                console.log(`   Matches direction? ${matchesDirection} (looking for ${obj.target.direction})`);
                                
                                if (matchesDirection) {
                                    obj.progress = (obj.progress || 0) + 1;
                                    console.log(`   ‚úÖ Progress updated: ${obj.progress}/${obj.target.count}`);
                                    
                                    if (obj.progress >= obj.target.count) {
                                        obj.completed = true;
                                        objectivesCompleted++;
                                        console.log(`   üéâ ${faction.name} completed: ${obj.text}`);
                                    }
                                } else {
                                    console.log(`   ‚ùå Wrong direction (got ${effect > 0 ? 'increase' : 'decrease'})`);
                                }
                            } else {
                                console.log(`   ‚ö†Ô∏è No effect on this metric`);
                            }
                        }
                        // Multiple metrics (feminist)
                        if (obj.target.metrics && policyEffects) {
                            const matchesAny = obj.target.metrics.some(m => {
                                const effect = policyEffects[m];
                                return (m === 'inequality' && effect < 0) || (m === 'freedom' && effect > 0);
                            });
                            if (matchesAny) {
                                obj.progress = (obj.progress || 0) + 1;
                                if (obj.progress >= obj.target.count) {
                                    obj.completed = true;
                                    objectivesCompleted++;
                                    console.log(`‚úÖ ${faction.name} completed: ${obj.text}`);
                                }
                            }
                        }
                    }
                    
                    // Block policy objectives (vote NO on specific policies)
                    if (obj.type === 'block_policy' && !passed) {
                        if (obj.target.policies && obj.target.policies.includes(policyId)) {
                            obj.progress = (obj.progress || 0) + 1;
                            if (obj.progress >= obj.target.count) {
                                obj.completed = true;
                                objectivesCompleted++;
                                console.log(`‚úÖ ${faction.name} completed: ${obj.text}`);
                            }
                        }
                    }
                    
                    // Specific policy objectives (pass specific policy)
                    if (obj.type === 'specific_policy' && passed) {
                        if (obj.target.policy === policyId) {
                            obj.completed = true;
                            objectivesCompleted++;
                            console.log(`‚úÖ ${faction.name} completed: ${obj.text}`);
                        }
                    }
                    
                    // Maintain metric objectives (check every round)
                    if (obj.type === 'maintain_metric' && !obj.failed) {
                        const currentValue = metrics[obj.target.metric];
                        const targetValue = obj.target.value;
                        const passes = obj.target.operator === '>' ? 
                            currentValue > targetValue : 
                            currentValue < targetValue;
                        
                        if (!passes) {
                            obj.failed = true;
                            console.log(`‚ùå ${faction.name} failed: ${obj.text}`);
                        }
                    }
                    
                    // Bonus: prevent policy (vote NO and it fails)
                    if (obj.type === 'bonus' && obj.target.preventPolicy && !passed) {
                        if (obj.target.preventPolicy === policyId && faction.vote === false) {
                            obj.completed = true;
                            objectivesCompleted++;
                            console.log(`‚úÖ ${faction.name} completed BONUS: ${obj.text}`);
                        }
                    }
                    
                    if (!obj.completed && obj.type !== 'final_metric' && obj.type !== 'bonus') {
                        allComplete = false;
                    }
                });
                
                // Award bonus if all main objectives complete (excluding failed maintain objectives)
                const mainObjectives = faction.objectives.filter(o => !o.text.includes('BONUS'));
                const completedMain = mainObjectives.filter(o => o.completed).length;
                const allMainComplete = mainObjectives.every(o => 
                    o.completed || (o.type === 'maintain_metric' && !o.failed) || o.type === 'final_metric'
                );
                
                console.log(`\nüìä ${faction.name} Objective Summary:`);
                console.log(`   Main objectives: ${completedMain}/${mainObjectives.length} completed`);
                faction.objectives.forEach(obj => {
                    let progressStr = '';
                    if (obj.progress) {
                        if (obj.type === 'metric_change' && obj.target.change) {
                            progressStr = `üü° ${obj.progress}/${Math.abs(obj.target.change)}`;
                        } else if (obj.target.count) {
                            progressStr = `üü° ${obj.progress}/${obj.target.count}`;
                        } else {
                            progressStr = `üü° ${obj.progress}`;
                        }
                    }
                    const status = obj.completed ? '‚úÖ' : obj.failed ? '‚ùå' : progressStr || '‚¨ú';
                    console.log(`   ${status} ${obj.text}`);
                });
                
                if (allMainComplete && !faction.objectivesBonus) {
                    faction.objectivesBonus = true;
                    faction.voterApproval = Math.min(100, (faction.voterApproval || 50) + 40);
                    console.log(`   üèÜ ${faction.name} completed all main objectives! +40% approval`);
                }
            });
        }
        
        // Simple proposal for teacher
        function teacherSelectProposal() {
            const proposerId = document.getElementById('proposerSelect').value;
            const policyId = document.getElementById('policySelect').value;
            
            const proposer = gameData.factions.find(f => f.id === proposerId);
            const policy = getPolicyDetails(policyId);
            
            socket.emit('selectProposal', { policy, proposer });
        }
        
        function startVoting() {
            socket.emit('startVoting');
        }
        
        socket.on('allVotesIn', () => {
            if (userRole === 'teacher') {
                document.getElementById('teacherVotingArea').innerHTML = `
                    <button class="btn" onclick="tallyVotes()">Tally Votes & Show Results</button>
                `;
            }
        });
        
        function tallyVotes() {
            socket.emit('tallyVotes');
        }
        
        function nextRound() {
            console.log('üîÑ Teacher clicked Continue to Next Round');
            
            // Clear results immediately for visual feedback
            document.getElementById('teacherResults').innerHTML = `
                <div class="alert alert-info" style="padding: 20px; margin: 20px 0;">
                    <h3>üîÑ Starting Next Round...</h3>
                </div>
            `;
            document.getElementById('teacherProposalArea').innerHTML = '';
            
            // Emit to server
            socket.emit('nextRound');
        }
        
        function endGame() {
            if (confirm('End the game and show the winner?')) {
                socket.emit('endGame');
            }
        }
        
        function triggerRandomEvent() {
            const eventSelect = document.getElementById('randomEventSelect');
            const eventId = eventSelect.value;
            
            if (!eventId) {
                alert('Please select an event first!');
                return;
            }
            
            if (confirm(`Trigger this event? It will affect national metrics and all players will see the announcement.`)) {
                socket.emit('triggerRandomEvent', { eventId });
                eventSelect.value = ''; // Reset selection
            }
        }
        
        socket.on('gameEnded', (data) => {
            const winner = data.winner;
            const allFactions = data.factions;
            
            // Update display screen with game over results
            if (userRole === 'display') {
                document.getElementById('displayScreen').innerHTML = `
                    <div style="max-width: 1400px; margin: 0 auto; padding: 50px; text-align: center;">
                        <h1 style="font-size: 4em; margin-bottom: 40px; color: #667eea;">üéâ GAME OVER! üéâ</h1>
                        
                        <div style="background: ${winner.color}22; border: 8px solid ${winner.color}; border-radius: 30px; padding: 60px; margin: 40px auto; max-width: 800px;">
                            <div style="font-size: 8em; margin-bottom: 30px;">${winner.icon}</div>
                            <h2 style="color: ${winner.color}; font-size: 3.5em; margin-bottom: 20px;">${winner.name}</h2>
                            <h3 style="font-size: 2.5em; margin-bottom: 20px;">WINS!</h3>
                            <p style="font-size: 2.5em; margin-top: 30px; font-weight: bold; color: #2c3e50;">üèÜ Final Score: ${winner.finalScore ? winner.finalScore.toFixed(1) : 'N/A'}</p>
                            <div style="font-size: 1.8em; margin-top: 25px; opacity: 0.9; color: #555;">
                                üìä ${winner.voterApproval}% Approval + üí∞ ${winner.tokens.capital} Tokens
                            </div>
                        </div>
                        
                        <h2 style="font-size: 2.5em; margin: 60px 0 30px; color: #667eea;">üìä FINAL RANKINGS</h2>
                        <div style="max-width: 900px; margin: 0 auto;">
                            ${allFactions.map((f, i) => `
                                <div style="background: white; padding: 30px; margin: 20px 0; border-radius: 15px; border-left: 8px solid ${f.color}; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: left;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3 style="font-size: 2em; color: #2c3e50;">#${i + 1} ${f.icon} ${f.name}</h3>
                                        <div style="font-size: 2.2em; font-weight: bold; color: ${f.color};">
                                            üèÜ ${f.finalScore ? f.finalScore.toFixed(1) : 'N/A'}
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 1.4em; margin-top: 15px;">
                                        <div>üìä Approval: <strong>${f.voterApproval}%</strong></div>
                                        <div>üí∞ Capital: <strong>${f.tokens.capital}</strong></div>
                                    </div>
                                    ${f.objectivesBonus ? '<div style="color: #27ae60; font-weight: bold; margin-top: 15px; font-size: 1.3em;">‚úÖ Objectives Bonus: +10%</div>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (userRole === 'teacher') {
                document.getElementById('teacherGame').innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h1 style="font-size: 3em; margin-bottom: 30px;">üéâ GAME OVER! üéâ</h1>
                        <div style="background: ${winner.color}22; border: 5px solid ${winner.color}; border-radius: 20px; padding: 40px; margin: 30px auto; max-width: 600px;">
                            <div style="font-size: 5em; margin-bottom: 20px;">${winner.icon}</div>
                            <h2 style="color: ${winner.color}; font-size: 2.5em;">${winner.name} WINS!</h2>
                            <p style="font-size: 1.8em; margin-top: 20px; font-weight: bold;">üèÜ Final Score: ${winner.finalScore ? winner.finalScore.toFixed(1) : 'N/A'}</p>
                            <div style="font-size: 1.2em; margin-top: 15px; opacity: 0.8;">
                                üìä ${winner.voterApproval}% Approval + üí∞ ${winner.tokens.capital} Tokens
                            </div>
                        </div>
                        
                        <h2 style="margin: 40px 0 20px;">Final Rankings:</h2>
                        ${allFactions.map((f, i) => `
                            <div class="stats-box" style="border-left: 5px solid ${f.color}; margin: 15px auto; max-width: 500px;">
                                <h3>#${i + 1} ${f.icon} ${f.name}</h3>
                                <div class="stat-item" style="font-size: 1.3em; font-weight: bold; color: #2c3e50; margin-bottom: 10px;">
                                    <span>üèÜ Final Score:</span>
                                    <strong>${f.finalScore ? f.finalScore.toFixed(1) : 'N/A'}</strong>
                                </div>
                                <div class="stat-item">
                                    <span>üìä Voter Base Approval:</span>
                                    <strong>${f.voterApproval}%</strong>
                                </div>
                                <div class="stat-item">
                                    <span>üí∞ Political Capital:</span>
                                    <strong>${f.tokens.capital} tokens</strong>
                                </div>
                                ${f.objectivesBonus ? '<div style="color: #27ae60; font-weight: bold; margin-top: 10px;">‚úÖ Objectives Bonus: +10%</div>' : ''}
                            </div>
                        `).join('')}
                        
                        <button class="btn" onclick="location.reload()" style="margin-top: 40px; font-size: 1.3em; padding: 20px 50px;">
                            üîÑ Start New Game
                        </button>
                    </div>
                `;
            }
            
            if (userRole === 'student') {
                const myFaction = allFactions.find(f => f.id === myFactionId);
                const myRank = allFactions.findIndex(f => f.id === myFactionId) + 1;
                const isWinner = myFactionId === winner.id;
                
                document.getElementById('studentView').innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <h1 style="font-size: 2.5em; margin-bottom: 30px;">${isWinner ? 'üéâ YOU WON! üéâ' : 'Game Over'}</h1>
                        
                        ${isWinner ? `
                            <div style="background: ${myFaction.color}22; border: 5px solid ${myFaction.color}; border-radius: 20px; padding: 40px; margin: 30px 0;">
                                <div style="font-size: 4em; margin-bottom: 20px;">${myFaction.icon}</div>
                                <h2 style="color: ${myFaction.color}; font-size: 2em;">VICTORY!</h2>
                                <p style="font-size: 1.5em; margin-top: 20px; font-weight: bold;">üèÜ Score: ${myFaction.finalScore ? myFaction.finalScore.toFixed(1) : 'N/A'}</p>
                                <p style="font-size: 1.2em; margin-top: 10px;">üìä ${myFaction.voterApproval}% Approval + üí∞ ${myFaction.tokens.capital} Tokens</p>
                            </div>
                        ` : `
                            <div class="stats-box" style="border-left: 5px solid ${myFaction.color}; margin: 30px 0;">
                                <h2>Your Final Position: #${myRank}</h2>
                                <h3>${myFaction.icon} ${myFaction.name}</h3>
                                <div class="stat-item" style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">
                                    <span>üèÜ Final Score:</span>
                                    <strong>${myFaction.finalScore ? myFaction.finalScore.toFixed(1) : 'N/A'}</strong>
                                </div>
                                <div class="stat-item">
                                    <span>üìä Voter Base Approval:</span>
                                    <strong>${myFaction.voterApproval}%</strong>
                                </div>
                                <div class="stat-item">
                                    <span>üí∞ Political Capital:</span>
                                    <strong>${myFaction.tokens.capital} tokens</strong>
                                </div>
                                ${myFaction.objectivesBonus ? '<div style="color: #27ae60; font-weight: bold; margin-top: 10px;">‚úÖ Objectives Bonus!</div>' : ''}
                            </div>
                            
                            <div style="background: ${winner.color}22; border: 3px solid ${winner.color}; border-radius: 15px; padding: 30px; margin: 30px 0;">
                                <h3>Winner:</h3>
                                <h2 style="color: ${winner.color};">${winner.icon} ${winner.name}</h2>
                                <p style="font-size: 1.3em; margin-top: 10px; font-weight: bold;">üèÜ ${winner.finalScore ? winner.finalScore.toFixed(1) : 'N/A'}</p>
                                <p style="font-size: 1.1em; margin-top: 5px;">üìä ${winner.voterApproval}% + üí∞ ${winner.tokens.capital} tokens</p>
                            </div>
                        `}
                        
                        <div class="alert alert-info" style="margin-top: 30px;">
                            <h3>Thanks for playing! üéÆ</h3>
                            <p>Wait for teacher to start a new game.</p>
                        </div>
                    </div>
                `;
            }
        });
        
        socket.on('gameState', (state) => {
            if (!gameData) gameData = {};
            
            if (state.metrics) {
                gameData.metrics = state.metrics;
            }
            if (state.factions) {
                gameData.factions = state.factions;
            }
            if (state.students) {
                gameData.students = state.students;
            }
            if (state.currentPhase) {
                gameData.currentPhase = state.currentPhase;
            }
            if (state.currentRound) {
                gameData.currentRound = state.currentRound;
            }
            if (state.maxRounds) {
                gameData.maxRounds = state.maxRounds;
            }
            if (state.lastPolicyResult) {
                gameData.lastPolicyResult = state.lastPolicyResult;
            }
            if (state.previousMetrics) {
                gameData.previousMetrics = state.previousMetrics;
            }
            if (state.policyHistory) {
                gameData.policyHistory = state.policyHistory;
            }
            
            // Update display screen if this is display mode
            if (userRole === 'display') {
                updateDisplayScreen();
            }
        });
        
        socket.on('gameError', (data) => {
            console.error('‚ùå Game Error:', data.message);
            if (userRole === 'teacher') {
                alert('‚ö†Ô∏è Game Error: ' + data.message);
            }
        });
        
        socket.on('randomEventTriggered', (data) => {
            // Show dramatic announcement overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.5s;
            `;
            
            overlay.innerHTML = `
                <div style="
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    max-width: 600px;
                    text-align: center;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                    animation: slideIn 0.5s;
                ">
                    <h1 style="font-size: 3em; margin: 0 0 20px 0;">${data.icon}</h1>
                    <h2 style="color: #e74c3c; margin: 0 0 15px 0; font-size: 2em;">${data.title}</h2>
                    <p style="font-size: 1.2em; line-height: 1.6; color: #333; margin-bottom: 25px;">${data.description}</p>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                        <h3 style="margin: 0 0 15px 0; color: #666;">üìä Effects on National Metrics:</h3>
                        ${Object.entries(data.effects).map(([key, value]) => {
                            const icon = key === 'gdp' ? 'üí∞' : key === 'inequality' ? 'üìä' : key === 'freedom' ? 'üóΩ' : key === 'socialCohesion' ? 'ü§ù' : 'üå±';
                            const color = value > 0 ? '#27ae60' : '#e74c3c';
                            return `<div style="margin: 8px 0; font-size: 1.1em;">
                                ${icon} ${key.charAt(0).toUpperCase() + key.slice(1)}: 
                                <strong style="color: ${color};">${value > 0 ? '+' : ''}${value}</strong>
                            </div>`;
                        }).join('')}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        padding: 15px 40px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-size: 1.2em;
                        cursor: pointer;
                        font-weight: bold;
                    ">Continue Game</button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Update metrics display if visible
            if (gameData && gameData.metrics) {
                Object.keys(data.effects).forEach(metric => {
                    if (gameData.metrics[metric] !== undefined) {
                        gameData.metrics[metric] += data.effects[metric];
                    }
                });
                
                // Refresh displays
                if (userRole === 'teacher') {
                    showTeacherGame();
                }
            }
        });
        
        socket.on('roundChanged', (data) => {
            console.log('üîÑ Round changed to:', data.round, 'Phase:', data.phase);
            
            if (!gameData) gameData = {};
            gameData.currentRound = data.round;
            gameData.currentPhase = data.phase;
            gameData.currentProposal = null;
            
            if (userRole === 'teacher') {
                console.log('üîÑ Teacher: Clearing old UI elements');
                
                // Clear ALL previous round elements
                document.getElementById('teacherResults').innerHTML = '';
                document.getElementById('teacherVotingArea').innerHTML = '';
                document.getElementById('teacherProposalArea').innerHTML = '';
                
                console.log('üîÑ Teacher: Rebuilding proposal UI for round', data.round);
                
                // Now rebuild the entire teacher interface
                showTeacherGame();
                
                console.log('‚úÖ Teacher view updated successfully for round', data.round);
            }
            
            if (userRole === 'student') {
                console.log('üîÑ Student: Clearing old UI elements');
                
                document.getElementById('studentResults').innerHTML = '';
                document.getElementById('studentVoting').innerHTML = '';
                document.getElementById('studentProposal').innerHTML = `
                    <div class="alert alert-info" style="padding: 20px; margin: 20px 0;">
                        <h3>üîÑ Round ${data.round} Starting...</h3>
                        <p style="font-size: 1.1em;">Waiting for teacher to select next proposal...</p>
                    </div>
                `;
                
                console.log('‚úÖ Student view cleared for round', data.round);
            }
            
            if (userRole === 'display') {
                console.log('üì∫ Display: Updating for round', data.round);
                updateDisplayScreen();
            }
        });
    </script>
</body>
</html>
