<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coalition Politics - Multiplayer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        h1 { color: #667eea; text-align: center; margin-bottom: 30px; }
        h2 { color: #333; margin: 20px 0; }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        
        .btn:hover { background: #5568d3; transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .btn-yes { background: #2ecc71; }
        .btn-yes:hover { background: #27ae60; }
        .btn-no { background: #e74c3c; }
        .btn-no:hover { background: #c0392b; }
        
        .hidden { display: none !important; }
        
        .faction-card {
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .faction-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .faction-card.selected { border-color: #667eea; background: #f0f3ff; }
        
        .faction-icon { font-size: 3em; text-align: center; margin-bottom: 10px; }
        .faction-name { font-size: 1.5em; font-weight: bold; text-align: center; }
        
        .stats-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .stat-item:last-child { border-bottom: none; }
        
        .objectives-box {
            background: #fff3cd;
            border: 3px solid #ffc107;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .objectives-box h3 { color: #856404; margin-bottom: 15px; }
        .objectives-box li { margin: 10px 0; line-height: 1.6; }
        
        .proposal-box {
            background: #e3f2fd;
            border-left: 5px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        
        .token-transfer {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .faction-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .faction-btn:hover { background: #f0f0f0; transform: scale(1.05); }
        
        select, input {
            padding: 12px;
            font-size: 1em;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 5px;
        }
        
        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            text-align: center;
        }
        
        .alert-success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }
        
        @media (max-width: 768px) {
            .container { padding: 15px; }
            h1 { font-size: 1.5em; }
            .btn { padding: 12px 20px; font-size: 1em; }
        }
    </style>
</head>
<body>
    <!-- Role Selection -->
    <div id="roleSelection" class="container">
        <h1>üèõÔ∏è Coalition Politics</h1>
        <div style="text-align: center; margin-top: 50px;">
            <button class="btn" onclick="selectRole('teacher')" style="font-size: 1.5em; padding: 30px 60px;">
                üë®‚Äçüè´ I am the Teacher
            </button>
            <br><br>
            <button class="btn" onclick="selectRole('student')" style="font-size: 1.5em; padding: 30px 60px;">
                üë§ I am a Student
            </button>
        </div>
    </div>
    
    <!-- Student Registration -->
    <div id="studentRegistration" class="container hidden">
        <h1>üë§ Student Registration</h1>
        <div style="max-width: 500px; margin: 50px auto;">
            <input type="text" id="studentName" placeholder="Your Name" style="width: 100%; margin-bottom: 20px;">
            
            <h3 style="margin-bottom: 20px;">Select Your Faction:</h3>
            <div id="factionList"></div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="registerStudent()" style="font-size: 1.3em; padding: 20px 50px;">
                    Join Game
                </button>
            </div>
        </div>
    </div>
    
    <!-- Student Game View -->
    <div id="studentView" class="container hidden">
        <h1 id="studentTitle">üèõÔ∏è Your Faction</h1>
        
        <div id="studentFactionInfo"></div>
        <div id="studentObjectives"></div>
        <div id="studentProposal"></div>
        <div id="studentVoting"></div>
        <div id="studentResults"></div>
    </div>
    
    <!-- Teacher View -->
    <div id="teacherView" class="container hidden">
        <h1>üë®‚Äçüè´ Teacher Control Panel</h1>
        
        <div id="teacherSetup">
            <div class="alert alert-info" id="connectionInfo"></div>
            
            <div id="studentsConnected" style="margin: 20px 0;"></div>
            
            <h2>Select Factions (4-6):</h2>
            <div id="teacherFactionList"></div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="startGame()" style="font-size: 1.3em; padding: 20px 50px;" id="startGameBtn" disabled>
                    Start Game
                </button>
            </div>
        </div>
        
        <div id="teacherGame" class="hidden">
            <div id="teacherRoundInfo"></div>
            <div id="teacherFactionStatus"></div>
            <div id="teacherProposalArea"></div>
            <div id="teacherVotingArea"></div>
            <div id="teacherResults"></div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Initialize socket
        const socket = io();
        
        let userRole = null;
        let myFactionId = null;
        let selectedFactions = [];
        let gameData = null;
        
        // Faction definitions
        const factions = [
            { id: 'socialist', name: 'Socialist Party', icon: 'üåπ', color: '#e74c3c', description: 'Equality and workers rights' },
            { id: 'liberal', name: 'Liberal Democrats', icon: 'üóΩ', color: '#3498db', description: 'Individual freedoms' },
            { id: 'conservative', name: 'Conservative Party', icon: 'ü¶Ö', color: '#34495e', description: 'Tradition and fiscal responsibility' },
            { id: 'green', name: 'Green Party', icon: 'üå±', color: '#2ecc71', description: 'Environmental sustainability' },
            { id: 'libertarian', name: 'Libertarian Party', icon: 'üêç', color: '#f39c12', description: 'Minimal government' },
            { id: 'populist', name: 'National Populist', icon: 'üé≠', color: '#9b59b6', description: 'National interests' },
            { id: 'technofeudalist', name: 'Technofeudalist Party', icon: 'ü§ñ', color: '#16a085', description: 'Tech monopolies' },
            { id: 'feminist', name: 'Feminist Party', icon: '‚ôÄÔ∏è', color: '#e91e63', description: 'Gender equality' }
        ];
        
        // Role selection
        function selectRole(role) {
            userRole = role;
            document.getElementById('roleSelection').classList.add('hidden');
            
            if (role === 'teacher') {
                socket.emit('registerTeacher');
            } else {
                showStudentRegistration();
            }
        }
        
        // Show student registration
        function showStudentRegistration() {
            document.getElementById('studentRegistration').classList.remove('hidden');
            
            const list = document.getElementById('factionList');
            list.innerHTML = factions.map(f => `
                <div class="faction-card" onclick="selectFaction('${f.id}')" data-faction="${f.id}">
                    <div class="faction-icon">${f.icon}</div>
                    <div class="faction-name" style="color: ${f.color};">${f.name}</div>
                    <p style="text-align: center; color: #666; margin-top: 10px;">${f.description}</p>
                </div>
            `).join('');
        }
        
        let selectedStudentFaction = null;
        
        function selectFaction(factionId) {
            selectedStudentFaction = factionId;
            document.querySelectorAll('#factionList .faction-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-faction="${factionId}"]`).classList.add('selected');
        }
        
        function registerStudent() {
            const name = document.getElementById('studentName').value || 'Anonymous';
            
            if (!selectedStudentFaction) {
                alert('Please select a faction!');
                return;
            }
            
            myFactionId = selectedStudentFaction;
            socket.emit('registerStudent', { factionId: selectedStudentFaction, name });
        }
        
        // Socket event handlers
        socket.on('teacherRegistered', (data) => {
            document.getElementById('teacherView').classList.remove('hidden');
            document.getElementById('connectionInfo').innerHTML = `
                <strong>üì± Students connect to:</strong> http://${data.localIP}:3000
            `;
            initializeTeacherSetup();
        });
        
        socket.on('studentRegistered', (data) => {
            document.getElementById('studentRegistration').classList.add('hidden');
            document.getElementById('studentView').classList.remove('hidden');
            
            const faction = factions.find(f => f.id === data.factionId);
            document.getElementById('studentTitle').innerHTML = `${faction.icon} ${faction.name}`;
            document.getElementById('studentFactionInfo').innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ Connected! Waiting for teacher to start the game...
                </div>
            `;
        });
        
        socket.on('studentsUpdate', (students) => {
            const div = document.getElementById('studentsConnected');
            if (students.length === 0) {
                div.innerHTML = '<p>No students connected yet</p>';
            } else {
                div.innerHTML = `<h3>üë• Connected Students (${students.length}):</h3>` +
                    students.map(s => `<span style="margin: 5px; padding: 8px 15px; background: #e3f2fd; border-radius: 5px; display: inline-block;">${s.name} (${factions.find(f => f.id === s.factionId)?.name || s.factionId})</span>`).join('');
            }
        });
        
        // Teacher setup
        function initializeTeacherSetup() {
            const list = document.getElementById('teacherFactionList');
            list.innerHTML = factions.map(f => `
                <div class="faction-card" onclick="toggleTeacherFaction('${f.id}')" data-faction="${f.id}">
                    <div class="faction-icon">${f.icon}</div>
                    <div class="faction-name" style="color: ${f.color};">${f.name}</div>
                </div>
            `).join('');
        }
        
        function toggleTeacherFaction(factionId) {
            const card = document.querySelector(`#teacherFactionList [data-faction="${factionId}"]`);
            
            if (selectedFactions.includes(factionId)) {
                selectedFactions = selectedFactions.filter(id => id !== factionId);
                card.classList.remove('selected');
            } else {
                if (selectedFactions.length < 6) {
                    selectedFactions.push(factionId);
                    card.classList.add('selected');
                } else {
                    alert('Maximum 6 factions!');
                    return;
                }
            }
            
            document.getElementById('startGameBtn').disabled = selectedFactions.length < 4;
        }
        
        function startGame() {
            if (selectedFactions.length < 4) {
                alert('Select at least 4 factions!');
                return;
            }
            
            const gameFactions = selectedFactions.map(id => {
                const f = factions.find(faction => faction.id === id);
                return {
                    id: f.id,
                    name: f.name,
                    icon: f.icon,
                    color: f.color,
                    tokens: { capital: 5 },
                    voterApproval: 50, // Start at 50%
                    objectives: generateObjectives(f.id),
                    hasVoted: false,
                    vote: null
                };
            });
            
            socket.emit('startGame', { factions: gameFactions });
        }
        
        // Generate objectives (simplified - 3 simple goals per faction)
        function generateObjectives(factionId) {
            const objectives = {
                socialist: [
                    { 
                        id: 'socialist_1',
                        text: 'Pass 1 policy that reduces inequality',
                        type: 'policy_count',
                        target: { metric: 'inequality', direction: 'decrease', count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'socialist_2',
                        text: 'End game with inequality below 40',
                        type: 'final_metric',
                        target: { metric: 'inequality', operator: '<', value: 40 },
                        completed: false
                    },
                    { 
                        id: 'socialist_3',
                        text: 'End game with 10+ political capital',
                        type: 'final_metric',
                        target: { metric: 'tokens', operator: '>=', value: 10 },
                        completed: false
                    }
                ],
                liberal: [
                    { 
                        id: 'liberal_1',
                        text: 'Pass 1 environmental policy',
                        type: 'policy_count',
                        target: { metric: 'environment', direction: 'increase', count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'liberal_2',
                        text: 'End game with freedom above 65',
                        type: 'final_metric',
                        target: { metric: 'freedom', operator: '>', value: 65 },
                        completed: false
                    },
                    { 
                        id: 'liberal_3',
                        text: 'Block 1 policy that reduces freedom',
                        type: 'block_policy',
                        target: { policies: ['immigration_restrict', 'police_funding'], count: 1 },
                        completed: false,
                        progress: 0
                    }
                ],
                conservative: [
                    { 
                        id: 'conservative_1',
                        text: 'Pass 1 policy that increases GDP',
                        type: 'policy_count',
                        target: { metric: 'gdp', direction: 'increase', count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'conservative_2',
                        text: 'End game with GDP above 100',
                        type: 'final_metric',
                        target: { metric: 'gdp', operator: '>', value: 100 },
                        completed: false
                    },
                    { 
                        id: 'conservative_3',
                        text: 'Block 1 tax increase policy',
                        type: 'block_policy',
                        target: { policies: ['tax_rich'], count: 1 },
                        completed: false,
                        progress: 0
                    }
                ],
                green: [
                    { 
                        id: 'green_1',
                        text: 'Pass 1 environmental policy',
                        type: 'policy_count',
                        target: { metric: 'environment', direction: 'increase', count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'green_2',
                        text: 'End game with environment above 55',
                        type: 'final_metric',
                        target: { metric: 'environment', operator: '>', value: 55 },
                        completed: false
                    },
                    { 
                        id: 'green_3',
                        text: 'Block 1 policy that harms environment',
                        type: 'block_policy',
                        target: { policies: ['deregulate', 'cut_taxes'], count: 1 },
                        completed: false,
                        progress: 0
                    }
                ],
                libertarian: [
                    { 
                        id: 'libertarian_1',
                        text: 'Pass 1 policy that increases freedom',
                        type: 'policy_count',
                        target: { metric: 'freedom', direction: 'increase', count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'libertarian_2',
                        text: 'End game with freedom above 70',
                        type: 'final_metric',
                        target: { metric: 'freedom', operator: '>', value: 70 },
                        completed: false
                    },
                    { 
                        id: 'libertarian_3',
                        text: 'Block 1 government expansion policy',
                        type: 'block_policy',
                        target: { policies: ['universal_healthcare', 'police_funding', 'education_funding'], count: 1 },
                        completed: false,
                        progress: 0
                    }
                ],
                populist: [
                    { 
                        id: 'populist_1',
                        text: 'Pass immigration restriction policy',
                        type: 'specific_policy',
                        target: { policy: 'immigration_restrict' },
                        completed: false
                    },
                    { 
                        id: 'populist_2',
                        text: 'End with social cohesion above 65',
                        type: 'final_metric',
                        target: { metric: 'socialCohesion', operator: '>', value: 65 },
                        completed: false
                    },
                    { 
                        id: 'populist_3',
                        text: 'End game with 8+ political capital',
                        type: 'final_metric',
                        target: { metric: 'tokens', operator: '>=', value: 8 },
                        completed: false
                    }
                ],
                technofeudalist: [
                    { 
                        id: 'techno_1',
                        text: 'Pass 1 business-friendly policy',
                        type: 'policy_count',
                        target: { metric: 'gdp', direction: 'increase', policies: ['deregulate', 'cut_taxes'], count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'techno_2',
                        text: 'End game with GDP above 105',
                        type: 'final_metric',
                        target: { metric: 'gdp', operator: '>', value: 105 },
                        completed: false
                    },
                    { 
                        id: 'techno_3',
                        text: 'End game with 12+ political capital',
                        type: 'final_metric',
                        target: { metric: 'tokens', operator: '>=', value: 12 },
                        completed: false
                    }
                ],
                feminist: [
                    { 
                        id: 'feminist_1',
                        text: 'Pass 1 policy that reduces inequality',
                        type: 'policy_count',
                        target: { metric: 'inequality', direction: 'decrease', count: 1 },
                        completed: false,
                        progress: 0
                    },
                    { 
                        id: 'feminist_2',
                        text: 'End with social cohesion above 60',
                        type: 'final_metric',
                        target: { metric: 'socialCohesion', operator: '>', value: 60 },
                        completed: false
                    },
                    { 
                        id: 'feminist_3',
                        text: 'End game with 10+ political capital',
                        type: 'final_metric',
                        target: { metric: 'tokens', operator: '>=', value: 10 },
                        completed: false
                    }
                ]
            };
            return objectives[factionId] || [];
        }
        
        // Game started
        socket.on('gameStarted', (game) => {
            console.log('üéÆ Game started event received');
            gameData = game; // Store complete game state
            
            if (userRole === 'teacher') {
                document.getElementById('teacherSetup').classList.add('hidden');
                document.getElementById('teacherGame').classList.remove('hidden');
                showTeacherGame();
            }
        });
        
        // Student receives faction data
        socket.on('yourFaction', (data) => {
            console.log('üì• Received faction data:', data);
            
            const faction = data.faction;
            const allFactions = data.allFactions;
            
            // Add metrics if missing
            if (!gameData) gameData = {};
            if (!gameData.metrics) {
                gameData.metrics = {
                    gdp: 100,
                    inequality: 50,
                    freedom: 70,
                    socialCohesion: 60,
                    environment: 50
                };
            }
            
            // Store factions for later use
            if (!gameData.factions) gameData.factions = [];
            gameData.factions = data.allFactions.map(af => {
                const fullFaction = gameData.factions.find(f => f.id === af.id);
                return fullFaction || af;
            });
            const myFullFaction = gameData.factions.find(f => f.id === myFactionId);
            if (myFullFaction) {
                Object.assign(myFullFaction, faction);
            } else {
                gameData.factions.push(faction);
            }
            
            // Show national metrics first
            const metricsHTML = `
                <div class="stats-box" style="background: #e3f2fd; border-left: 5px solid #2196f3;">
                    <h3>üìä National Metrics</h3>
                    <div class="stat-item">
                        <span>üí∞ GDP:</span>
                        <strong>${gameData.metrics.gdp}</strong>
                    </div>
                    <div class="stat-item">
                        <span>üìä Inequality:</span>
                        <strong>${gameData.metrics.inequality}</strong>
                    </div>
                    <div class="stat-item">
                        <span>üóΩ Freedom:</span>
                        <strong>${gameData.metrics.freedom}</strong>
                    </div>
                    <div class="stat-item">
                        <span>ü§ù Social Cohesion:</span>
                        <strong>${gameData.metrics.socialCohesion}</strong>
                    </div>
                    <div class="stat-item">
                        <span>üå± Environment:</span>
                        <strong>${gameData.metrics.environment}</strong>
                    </div>
                </div>
            `;
            
            // Show faction info with stats
            document.getElementById('studentFactionInfo').innerHTML = metricsHTML + `
                <div class="stats-box" style="border-left: 5px solid ${faction.color}; margin-top: 20px;">
                    <h2 style="color: ${faction.color};">${faction.icon} ${faction.name}</h2>
                    <div class="stat-item">
                        <span><strong>üí∞ Political Capital:</strong></span>
                        <span style="font-size: 1.5em; font-weight: bold; color: ${faction.color};">${faction.tokens.capital}</span>
                    </div>
                    <div class="stat-item">
                        <span><strong>üìä Voter Base Approval:</strong></span>
                        <span style="font-size: 1.5em; font-weight: bold; color: ${faction.color};">${faction.voterApproval || 0}%</span>
                    </div>
                </div>
            `;
            
            // Show objectives if they exist
            if (faction.objectives && faction.objectives.length > 0) {
                const completedCount = faction.objectives.filter(o => o.completed).length;
                const failedObjectives = faction.objectives.filter(o => o.failed);
                
                document.getElementById('studentObjectives').innerHTML = `
                    <div class="objectives-box">
                        <h3>üéØ Your Secret Objectives (${completedCount}/${faction.objectives.length} complete)</h3>
                        <div style="background: #fff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <strong style="color: #d32f2f;">‚ö†Ô∏è KEEP SECRET!</strong> Don't show other factions!
                        </div>
                        <ul style="line-height: 2;">
                            ${faction.objectives.map(obj => {
                                let status = '';
                                let style = '';
                                if (obj.completed) {
                                    status = ' ‚úÖ';
                                    style = 'style="color: #2ecc71; text-decoration: line-through;"';
                                } else if (obj.failed) {
                                    status = ' ‚ùå';
                                    style = 'style="color: #e74c3c; text-decoration: line-through;"';
                                } else if (obj.progress > 0) {
                                    status = ` (${obj.progress}/${obj.target.count})`;
                                    style = 'style="color: #f39c12;"';
                                }
                                return `<li ${style}>${obj.text}${status}</li>`;
                            }).join('')}
                        </ul>
                        ${failedObjectives.length > 0 ? `
                            <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center; color: #721c24;">
                                <strong>‚ö†Ô∏è Warning: ${failedObjectives.length} objective(s) failed!</strong>
                            </div>
                        ` : ''}
                        ${faction.objectivesBonus ? `
                            <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin-top: 15px; text-align: center;">
                                <strong style="color: #155724; font-size: 1.3em;">üèÜ ALL OBJECTIVES COMPLETE!</strong><br>
                                <span style="color: #155724;">+10% Approval Bonus Awarded!</span>
                            </div>
                        ` : `
                            <div style="background: #fff; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
                                <strong>üèÜ Complete all 3 objectives for +10% approval bonus!</strong>
                            </div>
                        `}
                    </div>
                `;
            }
            
            // Token buttons removed from here - only shown during negotiation phase
        });
        
        // Send token
        function sendToken(toFactionId) {
            socket.emit('sendToken', { toFactionId });
            document.getElementById('studentProposal').innerHTML = `
                <div class="alert alert-success">‚úÖ Token sent!</div>
            `;
            setTimeout(() => {
                // Will be refreshed when server sends updated faction data
            }, 1000);
        }
        
        // Factions updated
        socket.on('factionsUpdated', (factions) => {
            gameData.factions = factions;
            if (userRole === 'teacher') {
                showTeacherGame();
            }
        });
        
        // Proposal selected
        socket.on('proposalSelected', (data) => {
            if (userRole === 'student') {
                document.getElementById('studentProposal').innerHTML = `
                    <div class="proposal-box">
                        <h3>üìã ${data.proposal.proposer.icon} ${data.proposal.proposer.name} proposes:</h3>
                        <h2 style="color: #2196f3; margin: 15px 0;">${data.proposal.policy.name}</h2>
                        <p style="font-size: 1.1em; line-height: 1.6;">${data.proposal.policy.description}</p>
                    </div>
                    <div class="alert alert-info">
                        ü§ù <strong>Negotiation Phase!</strong> Discuss and trade tokens with other factions before voting.
                    </div>
                `;
                
                // Show token transfer buttons ONLY during negotiation
                const myFaction = gameData?.factions?.find(f => f.id === myFactionId);
                if (myFaction && myFaction.tokens.capital > 0) {
                    const otherFactions = gameData.factions.filter(f => f.id !== myFactionId);
                    document.getElementById('studentProposal').innerHTML += `
                        <div style="margin: 20px 0; background: #fff3cd; padding: 20px; border-radius: 10px;">
                            <h3>üí∞ Trade Tokens (You have ${myFaction.tokens.capital}):</h3>
                            <div class="token-transfer">
                                ${otherFactions.map(f => `
                                    <button class="faction-btn" onclick="sendToken('${f.id}')" style="border-color: ${f.color};">
                                        ${f.icon} ${f.name}
                                    </button>
                                `).join('')}
                            </div>
                            <p style="color: #856404; margin-top: 10px;">üí° Build alliances to pass/block policies!</p>
                        </div>
                    `;
                }
            }
            
            if (userRole === 'teacher') {
                gameData.currentPhase = 'negotiation';
                showTeacherGame();
            }
        });
        
        // Voting started
        socket.on('votingStarted', (proposal) => {
            if (userRole === 'student') {
                document.getElementById('studentVoting').innerHTML = `
                    <div style="text-align: center; margin: 30px 0;">
                        <h2>üó≥Ô∏è Time to Vote!</h2>
                        <p style="margin: 20px 0; font-size: 1.2em;">Should this policy pass?</p>
                        <button class="btn btn-yes" onclick="vote(true)" style="font-size: 1.5em; padding: 25px 50px;">
                            ‚úì YES
                        </button>
                        <button class="btn btn-no" onclick="vote(false)" style="font-size: 1.5em; padding: 25px 50px;">
                            ‚úó NO
                        </button>
                    </div>
                `;
            }
        });
        
        // Submit vote
        function vote(voteValue) {
            socket.emit('submitVote', voteValue);
            document.getElementById('studentVoting').innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ You voted <strong>${voteValue ? 'YES' : 'NO'}</strong>. Waiting for other factions...
                </div>
            `;
        }
        
        // Vote results
        socket.on('voteResults', (results) => {
            // Update local game data with new metrics and factions
            if (!gameData) gameData = {};
            if (results.metrics) {
                gameData.metrics = results.metrics;
            }
            if (results.factions) {
                gameData.factions = results.factions;
            }
            
            // Check objectives after vote
            if (results.policyId && results.policyEffects) {
                checkObjectives(results.policyId, results.policyEffects, results.passed, results.metrics);
            }
            
            if (userRole === 'student') {
                const myFaction = results.factions.find(f => f.id === myFactionId);
                
                let metricsChange = '';
                if (results.passed && gameData.currentProposal && gameData.currentProposal.policy && gameData.currentProposal.policy.effects) {
                    metricsChange = '<h3>üìä National Metrics Changed:</h3><ul style="text-align: left; max-width: 400px; margin: 15px auto;">';
                    Object.entries(gameData.currentProposal.policy.effects).forEach(([metric, change]) => {
                        const label = {
                            gdp: 'üí∞ GDP',
                            inequality: 'üìä Inequality',
                            freedom: 'üóΩ Freedom',
                            socialCohesion: 'ü§ù Social Cohesion',
                            environment: 'üå± Environment'
                        }[metric] || metric;
                        metricsChange += `<li>${label}: <strong style="color: ${change > 0 ? '#2ecc71' : '#e74c3c'}">${change > 0 ? '+' : ''}${change}</strong></li>`;
                    });
                    metricsChange += '</ul>';
                }
                
                // Show objectives progress
                let objectivesStatus = '';
                if (myFaction.objectives) {
                    const completedCount = myFaction.objectives.filter(o => o.completed).length;
                    if (completedCount > 0 || myFaction.objectivesBonus) {
                        objectivesStatus = `<div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 10px;">
                            <strong>üéØ Objectives: ${completedCount}/${myFaction.objectives.length} completed</strong>
                            ${myFaction.objectivesBonus ? '<br><strong style="color: #2ecc71;">üèÜ ALL OBJECTIVES COMPLETE! +40% Approval Awarded!</strong>' : ''}
                        </div>`;
                    }
                }
                
                document.getElementById('studentResults').innerHTML = `
                    <div class="alert ${results.passed ? 'alert-success' : 'alert-warning'}">
                        <h2>üìä ${results.passed ? 'POLICY PASSED!' : 'POLICY REJECTED!'}</h2>
                        <p style="font-size: 1.2em; margin: 15px 0;">
                            ${results.yesVotes} YES votes, ${results.noVotes} NO votes
                        </p>
                        ${metricsChange}
                        ${objectivesStatus}
                        <div style="margin-top: 20px;">
                            <strong>Your new stats:</strong><br>
                            üí∞ Political Capital: ${myFaction.tokens.capital}<br>
                            üìä Voter Base Approval: ${myFaction.voterApproval || 50}%
                        </div>
                    </div>
                `;
                
                // Clear voting area and proposal area for next round
                document.getElementById('studentVoting').innerHTML = '';
                document.getElementById('studentProposal').innerHTML = `
                    <div class="alert alert-info">
                        Waiting for next proposal...
                    </div>
                `;
            }
            
            // Update teacher view
            if (userRole === 'teacher') {
                gameData.factions = results.factions;
                if (results.metrics) gameData.metrics = results.metrics;
                showTeacherGame();
                
                document.getElementById('teacherResults').innerHTML = `
                    <div class="alert ${results.passed ? 'alert-success' : 'alert-warning'}">
                        <h2>${results.passed ? '‚úÖ POLICY PASSED!' : '‚ùå POLICY REJECTED!'}</h2>
                        <p>${results.yesVotes} YES, ${results.noVotes} NO</p>
                    </div>
                    <button class="btn" onclick="nextRound()" style="font-size: 1.3em; padding: 20px 50px; margin-top: 20px;">
                        ‚û°Ô∏è Continue to Next Round
                    </button>
                `;
                document.getElementById('teacherVotingArea').innerHTML = '';
            }
        });
        
        // Teacher game view (simplified)
        function showTeacherGame() {
            if (!gameData) return;
            
            // Add metrics if they don't exist
            if (!gameData.metrics) {
                gameData.metrics = {
                    gdp: 100,
                    inequality: 50,
                    freedom: 70,
                    socialCohesion: 60,
                    environment: 50
                };
            }
            
            document.getElementById('teacherRoundInfo').innerHTML = `
                <div class="alert alert-info">
                    <h2>Round ${gameData.currentRound}</h2>
                    <p>Phase: ${gameData.currentPhase}</p>
                    <button class="btn" onclick="endGame()" style="background: #e74c3c; margin-top: 15px;">
                        üèÜ End Game & Show Winner
                    </button>
                </div>
                
                <div class="stats-box">
                    <h3>üìä National Metrics</h3>
                    <div class="stat-item">
                        <span>üí∞ GDP:</span>
                        <strong>${gameData.metrics.gdp}</strong>
                    </div>
                    <div class="stat-item">
                        <span>üìä Inequality:</span>
                        <strong>${gameData.metrics.inequality}</strong>
                    </div>
                    <div class="stat-item">
                        <span>üóΩ Freedom:</span>
                        <strong>${gameData.metrics.freedom}</strong>
                    </div>
                    <div class="stat-item">
                        <span>ü§ù Social Cohesion:</span>
                        <strong>${gameData.metrics.socialCohesion}</strong>
                    </div>
                    <div class="stat-item">
                        <span>üå± Environment:</span>
                        <strong>${gameData.metrics.environment}</strong>
                    </div>
                </div>
            `;
            
            // Show all factions with their stats
            document.getElementById('teacherFactionStatus').innerHTML = `
                <h2>Faction Status:</h2>
                ${gameData.factions.map(f => `
                    <div class="stats-box" style="border-left: 5px solid ${f.color};">
                        <h3>${f.icon} ${f.name}</h3>
                        <div class="stat-item">
                            <span>üí∞ Political Capital:</span>
                            <strong>${f.tokens.capital}</strong>
                        </div>
                        <div class="stat-item">
                            <span>üìä Voter Base Approval:</span>
                            <strong>${f.voterApproval || 50}%</strong>
                        </div>
                        ${f.hasVoted ? `<div style="color: #2ecc71; margin-top: 10px;">‚úì Voted ${f.vote ? 'YES' : 'NO'}</div>` : ''}
                    </div>
                `).join('')}
            `;
            
            // Teacher controls with policy selection
            if (gameData.currentPhase === 'proposal') {
                document.getElementById('teacherProposalArea').innerHTML = `
                    <h2>Select Policy to Propose:</h2>
                    <div style="margin: 20px 0;">
                        <h3>Who proposes?</h3>
                        <select id="proposerSelect" style="width: 100%; max-width: 400px;">
                            ${gameData.factions.map(f => `
                                <option value="${f.id}">${f.icon} ${f.name}</option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h3>Select Policy:</h3>
                        <select id="policySelect" style="width: 100%; max-width: 400px;">
                            <option value="tax_rich">Tax the Rich (+equality, -gdp)</option>
                            <option value="cut_taxes">Cut Taxes (+gdp, +inequality)</option>
                            <option value="green_energy">Green Energy Investment (+environment, -gdp)</option>
                            <option value="deregulate">Business Deregulation (+gdp, -environment)</option>
                            <option value="universal_healthcare">Universal Healthcare (+equality, +cohesion)</option>
                            <option value="immigration_open">Open Immigration (+gdp, -cohesion)</option>
                            <option value="immigration_restrict">Restrict Immigration (+cohesion, -freedom)</option>
                            <option value="labor_rights">Strengthen Labor Rights (+equality, -gdp)</option>
                            <option value="education_funding">Education Funding (+equality, +cohesion)</option>
                            <option value="police_funding">Increase Police (+cohesion, -freedom)</option>
                        </select>
                    </div>
                    
                    <button class="btn" onclick="teacherSelectProposal()" style="font-size: 1.2em; padding: 15px 40px;">
                        üìã Propose This Policy
                    </button>
                `;
            } else if (gameData.currentPhase === 'negotiation') {
                document.getElementById('teacherProposalArea').innerHTML = `
                    <div class="alert alert-warning" style="margin: 20px 0;">
                        <h3>ü§ù Negotiation Phase</h3>
                        <p style="font-size: 1.1em;">Students are discussing and trading tokens...</p>
                        <p style="color: #856404;">Give them time to form alliances before starting the vote.</p>
                    </div>
                    <button class="btn" onclick="startVoting()" style="font-size: 1.3em; padding: 20px 50px; margin-top: 20px;">
                        üó≥Ô∏è Start Voting
                    </button>
                `;
            } else if (gameData.currentPhase === 'voting') {
                document.getElementById('teacherVotingArea').innerHTML = `
                    <div class="alert alert-info">
                        <h3>üó≥Ô∏è Voting in Progress</h3>
                        <p>Waiting for all factions to vote...</p>
                        ${gameData.factions.map(f => `
                            <div style="margin: 5px 0;">${f.icon} ${f.name}: ${f.hasVoted ? '<strong style="color: #2ecc71;">‚úì Voted</strong>' : '<strong style="color: #f39c12;">‚è≥ Waiting...</strong>'}</div>
                        `).join('')}
                    </div>
                `;
            }
        }
        
        // Get policy details
        function getPolicyDetails(policyId) {
            const policies = {
                tax_rich: { 
                    id: 'tax_rich',
                    name: 'Tax the Wealthy', 
                    description: 'Increase taxes on high earners to fund social programs',
                    effects: { inequality: -15, gdp: -5 }
                },
                cut_taxes: { 
                    id: 'cut_taxes',
                    name: 'Cut Taxes', 
                    description: 'Reduce tax burden to stimulate economic growth',
                    effects: { gdp: 10, inequality: 10 }
                },
                green_energy: { 
                    id: 'green_energy',
                    name: 'Green Energy Investment', 
                    description: 'Massive investment in renewable energy infrastructure',
                    effects: { environment: 20, gdp: -10 }
                },
                deregulate: { 
                    id: 'deregulate',
                    name: 'Business Deregulation', 
                    description: 'Remove regulations to boost business growth',
                    effects: { gdp: 15, environment: -15 }
                },
                universal_healthcare: { 
                    id: 'universal_healthcare',
                    name: 'Universal Healthcare', 
                    description: 'Implement free healthcare for all citizens',
                    effects: { inequality: -10, socialCohesion: 10 }
                },
                immigration_open: { 
                    id: 'immigration_open',
                    name: 'Open Immigration', 
                    description: 'Ease immigration restrictions to grow workforce',
                    effects: { gdp: 10, socialCohesion: -10 }
                },
                immigration_restrict: { 
                    id: 'immigration_restrict',
                    name: 'Restrict Immigration', 
                    description: 'Tighten border controls and limit immigration',
                    effects: { socialCohesion: 10, freedom: -10 }
                },
                labor_rights: { 
                    id: 'labor_rights',
                    name: 'Strengthen Labor Rights', 
                    description: 'Increase worker protections and union power',
                    effects: { inequality: -15, gdp: -8 }
                },
                education_funding: { 
                    id: 'education_funding',
                    name: 'Education Funding', 
                    description: 'Major investment in public education',
                    effects: { inequality: -8, socialCohesion: 8 }
                },
                police_funding: { 
                    id: 'police_funding',
                    name: 'Increase Police Funding', 
                    description: 'Expand law enforcement presence',
                    effects: { socialCohesion: 8, freedom: -8 }
                }
            };
            return policies[policyId];
        }
        
        // Check objectives after vote
        function checkObjectives(policyId, policyEffects, passed, metrics) {
            if (!gameData || !gameData.factions) return;
            
            gameData.factions.forEach(faction => {
                if (!faction.objectives) return;
                
                let objectivesCompleted = 0;
                let allComplete = true;
                
                faction.objectives.forEach(obj => {
                    if (obj.completed) {
                        objectivesCompleted++;
                        return;
                    }
                    
                    // Policy count objectives (pass policies that affect certain metrics)
                    if (obj.type === 'policy_count' && passed && policyEffects) {
                        console.log(`üîç Checking policy_count objective for ${faction.name}: ${obj.text}`);
                        console.log(`   Policy effects:`, policyEffects);
                        console.log(`   Target metric: ${obj.target.metric}, direction: ${obj.target.direction}`);
                        
                        if (obj.target.metric) {
                            const effect = policyEffects[obj.target.metric];
                            console.log(`   Effect on ${obj.target.metric}: ${effect}`);
                            
                            if (effect) {
                                const matchesDirection = obj.target.direction === 'increase' ? effect > 0 : effect < 0;
                                console.log(`   Matches direction? ${matchesDirection} (looking for ${obj.target.direction})`);
                                
                                if (matchesDirection) {
                                    obj.progress = (obj.progress || 0) + 1;
                                    console.log(`   ‚úÖ Progress updated: ${obj.progress}/${obj.target.count}`);
                                    
                                    if (obj.progress >= obj.target.count) {
                                        obj.completed = true;
                                        objectivesCompleted++;
                                        console.log(`   üéâ ${faction.name} completed: ${obj.text}`);
                                    }
                                } else {
                                    console.log(`   ‚ùå Wrong direction (got ${effect > 0 ? 'increase' : 'decrease'})`);
                                }
                            } else {
                                console.log(`   ‚ö†Ô∏è No effect on this metric`);
                            }
                        }
                        // Multiple metrics (feminist)
                        if (obj.target.metrics && policyEffects) {
                            const matchesAny = obj.target.metrics.some(m => {
                                const effect = policyEffects[m];
                                return (m === 'inequality' && effect < 0) || (m === 'freedom' && effect > 0);
                            });
                            if (matchesAny) {
                                obj.progress = (obj.progress || 0) + 1;
                                if (obj.progress >= obj.target.count) {
                                    obj.completed = true;
                                    objectivesCompleted++;
                                    console.log(`‚úÖ ${faction.name} completed: ${obj.text}`);
                                }
                            }
                        }
                    }
                    
                    // Block policy objectives (vote NO on specific policies)
                    if (obj.type === 'block_policy' && !passed) {
                        if (obj.target.policies && obj.target.policies.includes(policyId)) {
                            obj.progress = (obj.progress || 0) + 1;
                            if (obj.progress >= obj.target.count) {
                                obj.completed = true;
                                objectivesCompleted++;
                                console.log(`‚úÖ ${faction.name} completed: ${obj.text}`);
                            }
                        }
                    }
                    
                    // Specific policy objectives (pass specific policy)
                    if (obj.type === 'specific_policy' && passed) {
                        if (obj.target.policy === policyId) {
                            obj.completed = true;
                            objectivesCompleted++;
                            console.log(`‚úÖ ${faction.name} completed: ${obj.text}`);
                        }
                    }
                    
                    // Maintain metric objectives (check every round)
                    if (obj.type === 'maintain_metric' && !obj.failed) {
                        const currentValue = metrics[obj.target.metric];
                        const targetValue = obj.target.value;
                        const passes = obj.target.operator === '>' ? 
                            currentValue > targetValue : 
                            currentValue < targetValue;
                        
                        if (!passes) {
                            obj.failed = true;
                            console.log(`‚ùå ${faction.name} failed: ${obj.text}`);
                        }
                    }
                    
                    // Bonus: prevent policy (vote NO and it fails)
                    if (obj.type === 'bonus' && obj.target.preventPolicy && !passed) {
                        if (obj.target.preventPolicy === policyId && faction.vote === false) {
                            obj.completed = true;
                            objectivesCompleted++;
                            console.log(`‚úÖ ${faction.name} completed BONUS: ${obj.text}`);
                        }
                    }
                    
                    if (!obj.completed && obj.type !== 'final_metric' && obj.type !== 'bonus') {
                        allComplete = false;
                    }
                });
                
                // Award bonus if all main objectives complete (excluding failed maintain objectives)
                const mainObjectives = faction.objectives.filter(o => !o.text.includes('BONUS'));
                const completedMain = mainObjectives.filter(o => o.completed).length;
                const allMainComplete = mainObjectives.every(o => 
                    o.completed || (o.type === 'maintain_metric' && !o.failed) || o.type === 'final_metric'
                );
                
                console.log(`\nüìä ${faction.name} Objective Summary:`);
                console.log(`   Main objectives: ${completedMain}/${mainObjectives.length} completed`);
                faction.objectives.forEach(obj => {
                    const status = obj.completed ? '‚úÖ' : obj.failed ? '‚ùå' : obj.progress ? `üü° ${obj.progress}/${obj.target.count}` : '‚¨ú';
                    console.log(`   ${status} ${obj.text}`);
                });
                
                if (allMainComplete && !faction.objectivesBonus) {
                    faction.objectivesBonus = true;
                    faction.voterApproval = Math.min(100, (faction.voterApproval || 50) + 40);
                    console.log(`   üèÜ ${faction.name} completed all main objectives! +40% approval`);
                }
            });
        }
        
        // Simple proposal for teacher
        function teacherSelectProposal() {
            const proposerId = document.getElementById('proposerSelect').value;
            const policyId = document.getElementById('policySelect').value;
            
            const proposer = gameData.factions.find(f => f.id === proposerId);
            const policy = getPolicyDetails(policyId);
            
            socket.emit('selectProposal', { policy, proposer });
        }
        
        function startVoting() {
            socket.emit('startVoting');
        }
        
        socket.on('allVotesIn', () => {
            if (userRole === 'teacher') {
                document.getElementById('teacherVotingArea').innerHTML = `
                    <button class="btn" onclick="tallyVotes()">Tally Votes & Show Results</button>
                `;
            }
        });
        
        function tallyVotes() {
            socket.emit('tallyVotes');
        }
        
        function nextRound() {
            socket.emit('nextRound');
            document.getElementById('teacherResults').innerHTML = '';
            document.getElementById('teacherProposalArea').innerHTML = '';
        }
        
        function endGame() {
            if (confirm('End the game and show the winner?')) {
                socket.emit('endGame');
            }
        }
        
        socket.on('gameEnded', (data) => {
            const winner = data.winner;
            const allFactions = data.factions;
            
            if (userRole === 'teacher') {
                document.getElementById('teacherGame').innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h1 style="font-size: 3em; margin-bottom: 30px;">üéâ GAME OVER! üéâ</h1>
                        <div style="background: ${winner.color}22; border: 5px solid ${winner.color}; border-radius: 20px; padding: 40px; margin: 30px auto; max-width: 600px;">
                            <div style="font-size: 5em; margin-bottom: 20px;">${winner.icon}</div>
                            <h2 style="color: ${winner.color}; font-size: 2.5em;">${winner.name} WINS!</h2>
                            <p style="font-size: 1.8em; margin-top: 20px; font-weight: bold;">üèÜ Final Score: ${winner.finalScore ? winner.finalScore.toFixed(1) : 'N/A'}</p>
                            <div style="font-size: 1.2em; margin-top: 15px; opacity: 0.8;">
                                üìä ${winner.voterApproval}% Approval + üí∞ ${winner.tokens.capital} Tokens
                            </div>
                        </div>
                        
                        <h2 style="margin: 40px 0 20px;">Final Rankings:</h2>
                        ${allFactions.map((f, i) => `
                            <div class="stats-box" style="border-left: 5px solid ${f.color}; margin: 15px auto; max-width: 500px;">
                                <h3>#${i + 1} ${f.icon} ${f.name}</h3>
                                <div class="stat-item" style="font-size: 1.3em; font-weight: bold; color: #2c3e50; margin-bottom: 10px;">
                                    <span>üèÜ Final Score:</span>
                                    <strong>${f.finalScore ? f.finalScore.toFixed(1) : 'N/A'}</strong>
                                </div>
                                <div class="stat-item">
                                    <span>üìä Voter Base Approval:</span>
                                    <strong>${f.voterApproval}%</strong>
                                </div>
                                <div class="stat-item">
                                    <span>üí∞ Political Capital:</span>
                                    <strong>${f.tokens.capital} tokens</strong>
                                </div>
                                ${f.objectivesBonus ? '<div style="color: #27ae60; font-weight: bold; margin-top: 10px;">‚úÖ Objectives Bonus: +10%</div>' : ''}
                            </div>
                        `).join('')}
                        
                        <button class="btn" onclick="location.reload()" style="margin-top: 40px; font-size: 1.3em; padding: 20px 50px;">
                            üîÑ Start New Game
                        </button>
                    </div>
                `;
            }
            
            if (userRole === 'student') {
                const myFaction = allFactions.find(f => f.id === myFactionId);
                const myRank = allFactions.findIndex(f => f.id === myFactionId) + 1;
                const isWinner = myFactionId === winner.id;
                
                document.getElementById('studentView').innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <h1 style="font-size: 2.5em; margin-bottom: 30px;">${isWinner ? 'üéâ YOU WON! üéâ' : 'Game Over'}</h1>
                        
                        ${isWinner ? `
                            <div style="background: ${myFaction.color}22; border: 5px solid ${myFaction.color}; border-radius: 20px; padding: 40px; margin: 30px 0;">
                                <div style="font-size: 4em; margin-bottom: 20px;">${myFaction.icon}</div>
                                <h2 style="color: ${myFaction.color}; font-size: 2em;">VICTORY!</h2>
                                <p style="font-size: 1.5em; margin-top: 20px; font-weight: bold;">üèÜ Score: ${myFaction.finalScore ? myFaction.finalScore.toFixed(1) : 'N/A'}</p>
                                <p style="font-size: 1.2em; margin-top: 10px;">üìä ${myFaction.voterApproval}% Approval + üí∞ ${myFaction.tokens.capital} Tokens</p>
                            </div>
                        ` : `
                            <div class="stats-box" style="border-left: 5px solid ${myFaction.color}; margin: 30px 0;">
                                <h2>Your Final Position: #${myRank}</h2>
                                <h3>${myFaction.icon} ${myFaction.name}</h3>
                                <div class="stat-item" style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">
                                    <span>üèÜ Final Score:</span>
                                    <strong>${myFaction.finalScore ? myFaction.finalScore.toFixed(1) : 'N/A'}</strong>
                                </div>
                                <div class="stat-item">
                                    <span>üìä Voter Base Approval:</span>
                                    <strong>${myFaction.voterApproval}%</strong>
                                </div>
                                <div class="stat-item">
                                    <span>üí∞ Political Capital:</span>
                                    <strong>${myFaction.tokens.capital} tokens</strong>
                                </div>
                                ${myFaction.objectivesBonus ? '<div style="color: #27ae60; font-weight: bold; margin-top: 10px;">‚úÖ Objectives Bonus!</div>' : ''}
                            </div>
                            
                            <div style="background: ${winner.color}22; border: 3px solid ${winner.color}; border-radius: 15px; padding: 30px; margin: 30px 0;">
                                <h3>Winner:</h3>
                                <h2 style="color: ${winner.color};">${winner.icon} ${winner.name}</h2>
                                <p style="font-size: 1.3em; margin-top: 10px; font-weight: bold;">üèÜ ${winner.finalScore ? winner.finalScore.toFixed(1) : 'N/A'}</p>
                                <p style="font-size: 1.1em; margin-top: 5px;">üìä ${winner.voterApproval}% + üí∞ ${winner.tokens.capital} tokens</p>
                            </div>
                        `}
                        
                        <div class="alert alert-info" style="margin-top: 30px;">
                            <h3>Thanks for playing! üéÆ</h3>
                            <p>Wait for teacher to start a new game.</p>
                        </div>
                    </div>
                `;
            }
        });
        
        socket.on('gameState', (state) => {
            if (!gameData) gameData = {};
            
            if (state.metrics) {
                gameData.metrics = state.metrics;
            }
            if (state.factions) {
                gameData.factions = state.factions;
            }
            if (state.currentPhase) {
                gameData.currentPhase = state.currentPhase;
            }
            if (state.currentRound) {
                gameData.currentRound = state.currentRound;
            }
            if (state.maxRounds) {
                gameData.maxRounds = state.maxRounds;
            }
        });
        
        socket.on('roundChanged', (data) => {
            console.log('üîÑ Round changed to:', data.round);
            
            if (!gameData) gameData = {};
            gameData.currentRound = data.round;
            gameData.currentPhase = data.phase;
            gameData.currentProposal = null;
            
            if (userRole === 'teacher') {
                // Clear results and voting areas first
                document.getElementById('teacherResults').innerHTML = '';
                document.getElementById('teacherVotingArea').innerHTML = '';
                
                // Now showTeacherGame will create the proposal interface
                showTeacherGame();
                
                console.log('‚úÖ Teacher view updated for round', data.round);
            }
            
            if (userRole === 'student') {
                document.getElementById('studentResults').innerHTML = '';
                document.getElementById('studentVoting').innerHTML = '';
                document.getElementById('studentProposal').innerHTML = `
                    <div class="alert alert-info">
                        <h3>üîÑ Round ${data.round} Starting...</h3>
                        <p>Waiting for next proposal...</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
